<!DOCTYPE html>
<html lang="vi">
<head>
  <!-- ==========================
       META & TITLE
       ========================== -->
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>S·∫Øp x·∫øp b√†n ti·ªác</title>
  <!-- ==========================
         B·∫¢N V5.0 - S·∫ÆP X·∫æP L·∫†I B·ªê C·ª§C THEO CHU·∫®N
              üéØ Qu·∫£n l√Ω b√†n ti·ªác
                  T·∫°o, x√≥a v√† ƒë·ªïi t√™n b√†n ti·ªác linh ho·∫°t.
                  Thi·∫øt l·∫≠p s·ªë l∆∞·ª£ng kh√°ch t·ªëi ƒëa cho t·ª´ng b√†n ho·∫∑c ch·ªânh h√†ng lo·∫°t.
                  Hi·ªÉn th·ªã tr·∫°ng th√°i b√†n (ƒë·ªß / qu√° s·ªë kh√°ch).

              üë• Qu·∫£n l√Ω danh s√°ch kh√°ch
                  Th√™m kh√°ch nhanh b·∫±ng c√°ch nh·∫≠p nhi·ªÅu t√™n c√πng l√∫c.
                  K√©o‚Äëth·∫£ kh√°ch gi·ªØa c√°c b√†n ho·∫∑c t·ª´ danh s√°ch ‚ÄúCh∆∞a s·∫Øp x·∫øp‚Äù.
                  H·ªó tr·ª£ thao t√°c tr√™n c·∫£ m√°y t√≠nh v√† thi·∫øt b·ªã c·∫£m ·ª©ng (Android).
                  Ch·∫ø ƒë·ªô x√≥a kh√°ch an to√†n v·ªõi x√°c nh·∫≠n.

              üíæ L∆∞u tr·ªØ & kh√¥i ph·ª•c
                  T·ª± ƒë·ªông l∆∞u tr·∫°ng th√°i b·ªë tr√≠ b√†n v√†o tr√¨nh duy·ªát.
                  Kh√¥i ph·ª•c d·ªØ li·ªáu khi m·ªü l·∫°i trang.
                  X√≥a to√†n b·ªô d·ªØ li·ªáu khi c·∫ßn l√†m l·∫°i t·ª´ ƒë·∫ßu.

              üì• Import / Export d·ªØ li·ªáu
                  Import danh s√°ch kh√°ch t·ª´ file CSV (Excel).
                  Export danh s√°ch kh√°ch ra CSV ƒë·ªÉ ch·ªânh s·ª≠a ho·∫∑c l∆∞u tr·ªØ.

              üñ®Ô∏è Xu·∫•t PDF
                  Xu·∫•t PDF to√†n b·ªô s∆° ƒë·ªì b√†n (m·ªói b√†n m·ªôt trang).
                  Xu·∫•t PDF ri√™ng cho t·ª´ng b√†n th√¥ng qua modal ch·ªçn b√†n.
                  Giao di·ªán PDF r√µ r√†ng, d·ªÖ in, ph√π h·ª£p in A4.

              üß≠ Giao di·ªán & tr·∫£i nghi·ªám
                  Giao di·ªán tr·ª±c quan, d·ªÖ s·ª≠ d·ª•ng.
                  Menu xu·∫•t g·ªçn g√†ng, modal r√µ r√†ng.
                  C√≥ ph·∫ßn h∆∞·ªõng d·∫´n s·ª≠ d·ª•ng t√≠ch h·ª£p s·∫µn.
        ========================== -->


  
  <!-- ==========================
       CSS
       ========================== -->
  <style>
/* =====================================================
   1. BASE / RESET
   ===================================================== */
* {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: Arial, Helvetica, sans-serif;
  background: #f4f6fb;
  color: #111;
  -webkit-tap-highlight-color: transparent;
}

.hidden {
  display: none !important;
}

/* =====================================================
   2. LAYOUT
   ===================================================== */
.layout {
  display: grid;
  grid-template-columns: 4fr 1.2fr;
  height: 100vh;
  gap: 12px;
  padding: 12px;
}

/* =====================================================
   3. BUTTONS & COMMON UI
   ===================================================== */
.btn {
  padding: 8px 12px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #fff;
  cursor: pointer;
  font-weight: bold;
  user-select: none;
}

.btn:hover {
  background: #eee;
}

#add-table {
  font-size: 22px;
  background: #111;
  color: #fff;
  border: none;
}

#clear-btn {
  border-color: #dc2626;
  color: #dc2626;
}

#clear-btn:hover {
  background: #dc2626;
  color: #fff;
}

/* =====================================================
   4. TOOLBAR & EXPORT
   ===================================================== */
.toolbar {
  display: flex;
  gap: 8px;
  align-items: center;
  flex-wrap: wrap;
}

#summary {
  margin-left: auto;
  font-weight: bold;
}

.export-menu {
  position: relative;
}

.export-dropdown {
  position: absolute;
  top: 110%;
  left: 0;
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 10px;
  padding: 6px;
  display: none;
  flex-direction: column;
  gap: 4px;
  z-index: 10;
  min-width: 200px;
}

.export-dropdown button {
  text-align: left;
}

/* =====================================================
   5. TABLES & GUESTS
   ===================================================== */
.tables {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
  gap: 12px;
  overflow: auto;
  margin-top: 10px;
}

.table {
  background: #fff;
  border-radius: 12px;
  padding: 10px;
  border: 1px solid #ddd;
  display: flex;
  flex-direction: column;
  position: relative;
}

.table.over {
  background: #fee2e2;
  border: 2px solid #dc2626;
}

/* Accent colors */
.table:nth-child(4n+1) { border-top: 4px solid #2563eb; }
.table:nth-child(4n+2) { border-top: 4px solid #16a34a; }
.table:nth-child(4n+3) { border-top: 4px solid #f59e0b; }
.table:nth-child(4n+4) { border-top: 4px solid #dc2626; }

.table-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
  padding-bottom: 6px;
  border-bottom: 1px solid #eee;
}

.table-title {
  margin: 0;
  font-size: 15px;
  outline: none;
}

.table-actions {
  display: flex;
  gap: 4px;
}

.table-actions button {
  padding: 6px 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
  background: #fff;
  cursor: pointer;
}

/* Guest list */
.guest-list {
  list-style: none;
  padding: 6px;
  margin: 8px 0;
  border: 2px dashed #ccc;
  min-height: 80px;
  border-radius: 8px;
  counter-reset: guest;
}

.guest-list li {
  background: #fff;
  border: 1px solid #ccc;
  border-radius: 6px;
  padding: 8px 12px;
  margin-bottom: 4px;
  cursor: grab;
  position: relative;
  user-select: none;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  min-width: 0;
}

.guest-list li:not(.drag-placeholder)::before {
  counter-increment: guest;
  content: counter(guest) ".";
  min-width: 28px;
  margin-right: 6px;
  color: #555;
  font-weight: bold;
  display: inline-flex; /* ‚≠ê D√íNG QUAN TR·ªåNG NH·∫§T */
}

.guest-name {
  flex: 1;
}
    

/* =====================================================
   6. SIDEBAR
   ===================================================== */
.sidebar {
  display: flex;
  flex-direction: column;
  gap: 12px;
  height: 100%;
  overflow: hidden;
}

.quick-add {
  background: #fff;
  border-radius: 12px;
  border: 1px solid #ddd;
  padding: 10px;
  position: sticky;
  top: 0;
  z-index: 10;
}

.quick-add textarea {
  width: 100%;
  height: 90px;
  resize: vertical;
  border-radius: 8px;
  padding: 8px;
}

.unassigned-card {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 0;
  background: #fff;
  border-radius: 12px;
  border: 1px solid #ddd;
}

.unassigned-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
  padding: 10px;
  border-bottom: 1px solid #eee;
  background: #fafafa;
  position: sticky;
  top: 0;
  z-index: 5;
}

/* Scroll b√™n tr√°i cho Ch∆∞a s·∫Øp x·∫øp */
.unassigned-scroll {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
  direction: rtl; /* ƒê·∫∑t scrollbar b√™n tr√°i */
  scrollbar-width: thin; /* Firefox */
  scrollbar-color: #ccc transparent;
}

/* N·ªôi dung b√™n trong v·∫´n ƒë·ªçc tr√°i sang ph·∫£i */
.unassigned-scroll > * {
  direction: ltr;
}

/* Scroll Chrome/Webkit */
.unassigned-scroll::-webkit-scrollbar {
  width: 8px;
}

.unassigned-scroll::-webkit-scrollbar-track {
  background: transparent;
}

.unassigned-scroll::-webkit-scrollbar-thumb {
  background-color: #ccc;
  border-radius: 4px;
}

/* T√™n kh√°ch trong Ch∆∞a s·∫Øp x·∫øp co l·∫°i khi h·∫πp */
#unassigned .guest-name {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}




/* =====================================================
   7. MODES & DRAG UI
   ===================================================== */

li.selected-guest .move-arrow {
  display: inline-block;
}

.delete-x {
  font-size: 22px;
  cursor: pointer;
  color: #dc2626;
}

.delete-mode li .delete-x {
  display: inline-block;
}

.marked-delete {
  opacity: 0.4;
  text-decoration: line-through;
}

.drag-placeholder {
  height: 32px;
  margin-bottom: 4px;
  border: 2px dashed #2563eb;
  border-radius: 6px;
  background: rgba(37, 99, 235, 0.08);
}

.dragging {
  opacity: 0.4;
}

@media (pointer: coarse) {
  .guest-list li {
    touch-action: none;
  }
}

.touch-dragging {
  position: fixed;
  z-index: 10000;
  pointer-events: none;
  opacity: 0.85;
  transform: scale(1.05);
  box-shadow: 0 8px 20px rgba(0,0,0,0.25);
  background: #fef3c7;
}

/* =====================================================
   8. MODAL & PRINT
   ===================================================== */
.modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.4);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.modal-content {
  background: #fff;
  padding: 16px;
  border-radius: 14px;
  width: 360px;
  max-width: 90vw;
  max-height: 80vh;
  overflow: auto;
}

@media print {
  body * { visibility: hidden; }
  #print-root, #print-root * { visibility: visible; }
  #print-root {
    position: absolute;
    inset: 0;
    padding: 12px;
  }
  .table { page-break-before: always; }
  @page { size: A4; margin: 10mm; }
}

#print-root {
  position: fixed;
  inset: 0;
  background: #fff;
  z-index: 9999;
  display: none;
  overflow: auto;
  padding: 12px;
}
/* =====================================================
   V5.1 ‚Äî Interaction Toggle UI
   ===================================================== */

/* N√∫t "!" hi·ªÉn th·ªã tooltip */
#interaction-toggle .info {
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 50%;
  background: #ddd;
  font-weight: bold;
  position: relative;
}
 
.move-btn {
  font-size: 20px;
  padding: 4px 6px;
  cursor: pointer;
  color: #2563eb;
  border-radius: 6px;
}

.move-btn:hover {
  background: #e0e7ff;
}
    
/* =====================================================
   V5.1 ‚Äî Toggle Tap/Drag (Slider Style)
   ===================================================== */

.toggle-wrapper {
  display: flex;
  align-items: center;
  gap: 10px;
}

.toggle-track {
  position: relative;
  width: 120px;
  height: 36px;
  background: #ddd;
  border-radius: 20px;
  display: flex;
  align-items: center;
  padding: 3px;
  box-sizing: border-box;
}

.toggle-btn {
  flex: 1;
  height: 100%;
  border: none;
  background: transparent;
  font-weight: bold;
  cursor: pointer;
  z-index: 2;
  color: #555;
  opacity: 0.5;
}

.toggle-btn.active {
  color: #0f9d58; /* Xanh l√° m·∫° */
  opacity: 1;
  font-weight: 700;
}

.toggle-thumb {
  position: absolute;
  top: 3px;
  left: 3px;
  width: 50%;
  height: calc(100% - 6px);
  background: #c8f7c5; /* Xanh l√° nh·∫°t */
  border-radius: 16px;
  transition: left 0.25s ease;
  z-index: 1;
}

/* Tooltip 2 d√≤ng */
#interaction-toggle .info {
  cursor: pointer;
  padding: 2px 6px;
  border-radius: 50%;
  background: #ddd;
  font-weight: bold;
  position: relative;
}

#interaction-toggle .info:hover::after {
  content: "Tap: ph√π h·ª£p cho Android.\A Drag: ph√π h·ª£p cho Windows.";
  white-space: pre;
  position: absolute;
  top: 32px;
  left: 0;
  background: #333;
  color: #fff;
  padding: 8px 10px;
  border-radius: 6px;
  font-size: 13px;
  z-index: 999;
}
    
/* move modal */
.move-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

.move-grid.single-column {
  grid-template-columns: 1fr;
}

.move-column h4 {
  margin-top: 0;
  margin-bottom: 8px;
}

.move-column .btn {
  width: 100%;
  margin-bottom: 6px;
}

/* N√∫t Ch∆∞a s·∫Øp x·∫øp */
.unassigned-btn {
  background: #dbeafe; /* xanh d∆∞∆°ng nh·∫°t */
  border-color: #93c5fd;
}

/* N√∫t b·ªã v√¥ hi·ªáu h√≥a */
.btn.disabled {
  opacity: 0.4;
  pointer-events: none;
}

/* =====================================================
   EDIT NAME MODE ‚Äî UI LOCKDOWN
   ===================================================== */

/* M·∫∑c ƒë·ªãnh: m·ªçi n√∫t d√πng .btn b·ªã m·ªù + kh√≥a */
body.edit-names-mode .btn {
  opacity: 0.3;
  pointer-events: none;
}

/* Ch·ªâ ƒê·ªìng √Ω / H·ªßy ƒë∆∞·ª£c b·∫•m v√† s√°ng */
body.edit-names-mode #edit-names-save,
body.edit-names-mode #edit-names-cancel {
  opacity: 1;
  pointer-events: auto;
}

/* N√∫t S·ª≠a t√™n kh√°ch (n·∫øu hi·ªán) v·∫´n s√°ng, nh∆∞ng JS s·∫Ω ·∫©n n√≥ trong edit mode */
body.edit-names-mode #edit-names-btn {
  opacity: 1;
  pointer-events: auto;
}

/* N√∫t Th√™m b√†n (+) KH√îNG d√πng class .btn n√™n ph·∫£i kh√≥a ri√™ng */
body.edit-names-mode #add-table {
  opacity: 0.3;
  pointer-events: none;
}

/* C√°c n√∫t trong header b√†n: s·ª≠a t√™n b√†n, x√≥a b√†n, quick-add
   ‚Üí D√ô c√≥ hay kh√¥ng c√≥ class .btn ƒë·ªÅu b·ªã kh√≥a */
body.edit-names-mode .table-actions button,
body.edit-names-mode .table-actions .btn {
  opacity: 0.3;
  pointer-events: none;
}

/* N√∫t + th√™m kh√°ch nhanh trong b√†n (n·∫øu l√† .quick-add-btn ri√™ng) */
body.edit-names-mode .quick-add-btn {
  opacity: 0.3;
  pointer-events: none;
}

/* √î input quick-add (n·∫øu ƒëang m·ªü) c≈©ng b·ªã kh√≥a */
body.edit-names-mode .quick-add-input {
  opacity: 0.3;
  pointer-events: none;
}

/* N√∫t move (Tap mode) ch·∫Øc ch·∫Øn b·ªã m·ªù + kh√¥ng b·∫•m ƒë∆∞·ª£c */
body.edit-names-mode .move-btn {
  opacity: 0.25;
  pointer-events: none;
}

/* N·∫øu tr∆∞·ªõc ƒë√¢y c√≥ tr·∫°ng th√°i selected-guest th√¨ x√≥a lu√¥n khi s·ª≠a t√™n */
body.edit-names-mode .selected-guest {
  background: none !important;
}
/* =====================================================
   QUICK ADD TO TABLE
   ===================================================== */
.quick-add-input {
  width: 100%;
  padding: 8px;
  border-radius: 8px;
  border: 1px solid #ccc;
  margin-bottom: 10px;
}

/* =====================================================
   GUEST ITEM ‚Äî CH∆ØA S·∫ÆP X·∫æP (RESPONSIVE FIX)
   ===================================================== */

/* M·ªói kh√°ch l√† flex item */
#unassigned li {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  border: 1px solid #ddd;
  border-radius: 8px;
  margin-bottom: 6px;
  min-width: 0;
  position: relative;
}

/* S·ªë th·ª© t·ª± b·∫±ng ::before */
#unassigned li::before {
  font-weight: bold;
  margin-right: 4px;
  flex-shrink: 0;
  display: inline-flex; /* ‚≠ê Cho ph√©p d√πng order */
}

/* T√™n kh√°ch co l·∫°i ƒë√∫ng */
#unassigned .guest-name {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Move v√† delete l√† n√∫t nh·ªè */
#unassigned .move-btn,
#unassigned .delete-x {
  flex-shrink: 0;
  cursor: pointer;
}


/* ===== Khi m√†n h√¨nh h·∫πp: chia 2 h√†ng ===== */
@media (max-width: 480px) {
  #unassigned li {
    display: flex;
    justify-content: flex-start; /* ‚úÖ Cho ph√©p xu·ªëng h√†ng */
    flex-wrap: wrap;
    align-items: center;
    gap: 6px;
    min-width: 0;
  }

  /* H√†ng 1: s·ªë th·ª© t·ª± (CSS counter), move, delete */
  #unassigned li::before {
    order: 1;
    flex-shrink: 0;
  }

  #unassigned li .move-btn {
    order: 2;
  }

  #unassigned li .delete-x {
    order: 3;
  }

  /* H√†ng 2: t√™n kh√°ch */
  #unassigned li .guest-name {
    order: 4;
    flex: unset; /* ‚≠ê G·ª° b·ªè flex: 1 */
    width: 100%; /* ‚≠ê Chi·∫øm to√†n b·ªô chi·ªÅu ngang */
    margin-top: 4px;
    white-space: normal; /* ‚≠ê Cho ph√©p xu·ªëng d√≤ng */
    word-break: break-word;
  }
}


  </style>
  
</head>

<body>

  <!-- ==========================
       HTML (UI / STRUCTURE)
       ========================== -->
  <!-- layout, toolbar, tables, sidebar, modals -->
<!-- =====================================================
     APP LAYOUT
     ===================================================== -->
<div class="layout">

  <!-- =====================================================
       MAIN AREA (LEFT)
       ===================================================== -->
  <div class="main">

    <!-- =======================
         TOOLBAR
         ======================= -->
    <div class="toolbar">

      <button id="add-table">+</button>
      <button id="adjust-max" class="btn">‚öôÔ∏è Ch·ªânh max</button>

      <button id="edit-names-btn" class="btn edit-only">‚úèÔ∏è S·ª≠a t√™n kh√°ch</button>
      <button id="edit-names-save" class="btn hidden edit-only">üíæ ƒê·ªìng √Ω</button>
      <button id="edit-names-cancel" class="btn hidden edit-only">‚ùå H·ªßy</button>

      <button id="save-btn" class="btn">üíæ L∆∞u</button>
      <button id="clear-btn" class="btn">üßπ X√≥a</button>

      <input type="file" id="import-csv" accept=".csv" hidden>
      <button id="import-btn" class="btn">üì• Import CSV</button>

      <!-- EXPORT -->
      <div class="export-menu">
        <button id="export-btn" class="btn">üì§ Xu·∫•t</button>
        <div id="export-menu" class="export-dropdown">
          <button id="export-csv">üìä Excel (CSV)</button>
          <button id="export-pdf-all">üñ®Ô∏è PDF t·∫•t c·∫£</button>
          <button id="export-pdf-one">üßæ PDF 1 b√†n</button>
        </div>
      </div>

      <button id="help-btn" class="btn">‚ùì H∆∞·ªõng d·∫´n</button>
      
<div id="interaction-toggle" class="toggle-wrapper">
  <div class="toggle-track">
    <div class="toggle-thumb"></div>
    <button data-mode="tap" class="toggle-btn">Tap</button>
    <button data-mode="drag" class="toggle-btn">Drag</button>
  </div>
  <span class="info">!</span>
</div>


      <!-- SUMMARY -->
      <div id="summary">
        T·ªïng: <span id="total-guests">0</span> kh√°ch ¬∑
        <span id="total-tables">0</span> b√†n
      </div>
    </div>

    <!-- BLOCKER (EDIT MODE) -->
    <div id="toolbar-blocker"></div>

    <!-- TABLES -->
    <div class="tables" id="tables"></div>
  </div>

  <!-- =====================================================
       SIDEBAR (RIGHT)
       ===================================================== -->
  <aside class="sidebar">

    <!-- QUICK ADD GUEST -->
    <section class="quick-add">
      <h3>Th√™m kh√°ch</h3>
      <textarea id="guest-input" placeholder="M·ªói d√≤ng l√† 1 t√™n..."></textarea>
      <button id="add-guest" class="btn">Th√™m</button>
    </section>

    <!-- UNASSIGNED -->
    <section class="unassigned-card">
      <div class="unassigned-header">
        <h3>Ch∆∞a s·∫Øp x·∫øp</h3>
        <div>
          <button id="delete-mode-btn" class="btn">üóëÔ∏è</button>
          <button id="delete-confirm-btn" class="btn hidden">‚úÖ</button>
          <button id="delete-cancel-btn" class="btn hidden">‚ùå</button>
        </div>
      </div>

      <div class="unassigned-scroll">
        <ul class="guest-list" id="unassigned"></ul>
      </div>
    </section>

  </aside>
</div>

<!-- =====================================================
     MODALS
     ===================================================== -->

<!-- MAX MODAL -->
<div class="modal" id="max-modal">
  <div class="modal-content">
    <h3>Ch·ªânh s·ªë kh√°ch t·ªëi ƒëa</h3>

    <div class="bulk-max">
      <label><b>Ch·ªânh h√†ng lo·∫°t:</b></label>
      <input type="number" id="bulk-max" min="1"
        placeholder="Nh·∫≠p s·ªë kh√°ch t·ªëi ƒëa...">
      <div class="hint">
        Khi nh·∫≠p s·ªë v√†o ƒë√¢y, t·∫•t c·∫£ b√†n s·∫Ω c√≥ s·ªë kh√°ch t·ªëi ƒëa gi·ªëng nhau.
      </div>
    </div>

    <div id="max-list"></div>

    <div class="modal-actions">
      <button id="max-cancel" class="btn">H·ªßy</button>
      <button id="max-save" class="btn">L∆∞u</button>
    </div>
  </div>
</div>

<!-- PDF ONE TABLE -->
<div class="modal" id="pdf-one-modal">
  <div class="modal-content">
    <h3>Xu·∫•t PDF 1 b√†n</h3>
    <select id="pdf-table-select"></select>

    <div class="modal-actions">
      <button id="pdf-one-cancel" class="btn">H·ªßy</button>
      <button id="pdf-one-export" class="btn">Xu·∫•t</button>
    </div>
  </div>
</div>

<!-- HELP -->
<div class="modal" id="help-modal">
  <div class="modal-content">
    <h3>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>

    <div id="help-content">
        <h4>1. T·∫°o b√†n</h4>
        <p>B·∫•m n√∫t <b>+</b> ƒë·ªÉ t·∫°o th√™m b√†n m·ªõi.</p>

        <h4>2. Ch·ªânh s·ªë kh√°ch t·ªëi ƒëa</h4>
        <p>B·∫•m <b>‚öôÔ∏è Ch·ªânh max</b> ƒë·ªÉ thay ƒë·ªïi s·ªë kh√°ch t·ªëi ƒëa c·ªßa t·ª´ng b√†n.</p>

        <h4>3. L∆∞u d·ªØ li·ªáu</h4>
        <p>B·∫•m <b>üíæ L∆∞u</b> ƒë·ªÉ l∆∞u to√†n b·ªô b·ªë c·ª•c v√†o tr√¨nh duy·ªát.</p>

        <h4>4. Xu·∫•t d·ªØ li·ªáu</h4>
        <p>D√πng menu <b>üì§ Xu·∫•t</b> ƒë·ªÉ xu·∫•t CSV, PDF t·∫•t c·∫£ ho·∫∑c PDF t·ª´ng b√†n.</p>

        <h4>5. Import CSV</h4>
        <p>B·∫•m <b>üì• Import CSV</b> ƒë·ªÉ nh·∫≠p danh s√°ch kh√°ch t·ª´ file CSV.</p>

        <h4>6. Th√™m kh√°ch v√†o b√†n</h4>
        <p>B·∫•m n√∫t <b>‚ûï</b> tr√™n m·ªói b√†n ƒë·ªÉ th√™m kh√°ch nhanh.</p>

        <h4>7. Th√™m kh√°ch nhanh</h4>
        <p>Nh·∫≠p nhi·ªÅu t√™n v√†o √¥ ‚ÄúTh√™m kh√°ch‚Äù (m·ªói d√≤ng 1 t√™n) r·ªìi b·∫•m <b>Th√™m</b>.</p>

        <h4>8. K√©o‚Äëth·∫£ kh√°ch</h4>
        <p>K√©o kh√°ch gi·ªØa c√°c b√†n ho·∫∑c t·ª´ ‚ÄúCh∆∞a s·∫Øp x·∫øp‚Äù ƒë·ªÉ b·ªë tr√≠ ch·ªó ng·ªìi.</p>
    </div>

    <div class="modal-actions">
      <button id="help-close" class="btn">Tr·ªü v·ªÅ</button>
    </div>
  </div>
</div>

  
<!-- MOVE MODAL -->
<div id="move-modal" class="modal">
  <div class="modal-content">
    <h3>Di chuy·ªÉn kh√°ch</h3>

    <div class="move-grid">
      <!-- C·ªôt tr√°i: Di chuy·ªÉn trong b√†n -->
      <div class="move-column move-column-left">
        <h4>Trong b√†n:</h4>
        <button class="btn move-top">‚¨Ü L√™n ƒë·∫ßu</button>
        <button class="btn move-up">üîº</button>
        <button class="btn move-down">üîΩ</button>
        <button class="btn move-bottom">‚¨á Xu·ªëng cu·ªëi</button>
      </div>

      <!-- C·ªôt ph·∫£i: Di chuy·ªÉn sang b√†n kh√°c -->
      <div class="move-column move-column-right">
        <h4>B√†n kh√°c:</h4>
        <div id="move-list"></div>
      </div>
    </div>

    <button id="move-cancel" class="btn move-close" style="margin-top:10px;width:100%">ƒê√≥ng</button>
  </div>
</div>

<!-- MODAL TH√äM KH√ÅCH V√ÄO B√ÄN -->
<div class="modal" id="quick-add-modal">
  <div class="modal-content">
    <h3>Nh·∫≠p t√™n kh√°ch ƒë·ªÉ th√™m v√†o b√†n:</h3>
    <input type="text" id="quick-add-input" placeholder="Nh·∫≠p t√™n kh√°ch..." class="quick-add-input">
    <div class="modal-actions">
      <button id="quick-add-cancel" class="btn">H·ªßy</button>
      <button id="quick-add-confirm" class="btn">Th√™m</button>
    </div>
  </div>
</div>



<!-- ROOT IN PDF -->
<div id="print-root"></div>



  
  <!-- ==========================
       JS
       ========================== -->
<script>
/* =====================================================
   MODULE 1 ‚Äî CORE & STATE
   ===================================================== */

/* ---------- DOM ROOT ---------- */
const tablesEl      = document.getElementById("tables");
const unassigned    = document.getElementById("unassigned");
const guestInput    = document.getElementById("guest-input");
const exportBtn     = document.getElementById("export-btn");
const exportMenu    = document.getElementById("export-menu");
const printRoot     = document.getElementById("print-root");

/* ---------- MODALS ---------- */
const maxModal      = document.getElementById("max-modal");
const maxList       = document.getElementById("max-list");
const pdfOneModal   = document.getElementById("pdf-one-modal");
const pdfTableSelect= document.getElementById("pdf-table-select");

/* ---------- ENV DETECT ---------- */
const isTouch   = ("ontouchstart" in window) || (navigator.maxTouchPoints > 0);
const isAndroid = /Android/i.test(navigator.userAgent || "");

/* ---------- GLOBAL STATE ---------- */
let editNamesMode   = false;
let deleteMode      = false;
let selectedGuest   = null;

/* ---------- DRAG STATE ---------- */
let draggedItem = null;
const dragPlaceholder = document.createElement("li");
dragPlaceholder.className = "drag-placeholder";
  
/* =====================================================
   V5.1 ‚Äî Interaction Mode
   "tap"  ‚Üí ch·∫°m kh√°ch ‚Üí ch·∫°m b√†n
   "drag" ‚Üí k√©o th·∫£ truy·ªÅn th·ªëng
   ===================================================== */

let interactionMode = "drag"; // m·∫∑c ƒë·ªãnh

</script>

<script>
/* =====================================================
   MODULE 2 ‚Äî HELPER & UTILS (V5.1 STABLE)
   ===================================================== */

/* ---------- STRING UTILS ---------- */
function normalizeName(str) {
  return String(str || "")
    .trim()
    .replace(/\s+/g, " ");
}

function stripQuotes(str) {
  return String(str || "")
    .replace(/^"(.*)"$/, "$1")
    .trim();
}

/* ---------- NAME DISPLAY ---------- */
function shortName(full) {
  const parts = normalizeName(full).split(" ");
  if (parts.length <= 2) return full;
  return parts.slice(-2).join(" ");
}

/* ---------- SAFE TEXT UPDATE ---------- */
function setGuestText(li, text) {
  const span = li.querySelector(".guest-name");
  if (span) span.textContent = text;
}

/* ---------- DOM HELPERS ---------- */
function qs(selector, root = document) {
  return root.querySelector(selector);
}

function qsa(selector, root = document) {
  return [...root.querySelectorAll(selector)];
}

/* =====================================================
   V5.1 ‚Äî √Åp d·ª•ng Interaction Mode (Tap / Drag)
   ===================================================== */
function applyInteractionMode() {

  /* ---------- DRAG MODE ---------- */
  if (interactionMode === "drag") {
    qsa(".guest-list li").forEach(li => {
      li.draggable = true;
      li.style.pointerEvents = "auto";
      li.onclick = null; // b·ªè ch·∫∑n click
    });
  }

  /* ---------- TAP MODE ---------- */
  if (interactionMode === "tap") {
    qsa(".guest-list li").forEach(li => {
      li.draggable = false;
      li.style.pointerEvents = "auto"; // KH√îNG t·∫Øt pointer-events

      // Ch·ªâ ch·∫∑n click v√†o li, KH√îNG ch·∫∑n click v√†o move-btn
      li.onclick = (e) => {
        if (!e.target.classList.contains("move-btn")) {
          e.stopPropagation();
        }
      };
    });
  }

  /* ---------- Hi·ªán/·∫©n icon Move ---------- */
  qsa(".move-btn").forEach(btn => {
    btn.style.display = (interactionMode === "tap")
      ? "inline-block"
      : "none";
  });
}


</script>

<script>
/* =====================================================
   MODULE 3 ‚Äî GUEST MODEL (V5.1 STABLE)
   ===================================================== */

/* ---------- CREATE GUEST <li> ---------- */
function createGuestLi(name) {
  const cleanName = normalizeName(name);
  if (!cleanName) return null;

  const li = document.createElement("li");
  li.dataset.name = cleanName;

  /* Guest name */
  const span = document.createElement("span");
  span.className = "guest-name";
  span.textContent = cleanName;
  li.appendChild(span);

  /* Move button (Tap Mode uses this) */
  const moveBtn = document.createElement("span");
  moveBtn.className = "move-btn";
  moveBtn.textContent = "‚Üó";
  li.appendChild(moveBtn);

  /* Drag behavior (only active when in Drag Mode) */
  li.draggable = true;

  return li;
}

/* ---------- READ NAME SAFELY ---------- */
function getGuestName(li) {
  return normalizeName(li?.dataset?.name || "");
}
</script>


<script>
/* =====================================================
   MODULE 4 ‚Äî TABLE MODEL
   ===================================================== */

/* ---------- CREATE TABLE ---------- */
function createTable(name, max = 10, guests = []) {
  const table = document.createElement("div");
  table.className = "table";
  table.dataset.baseName = normalizeName(name) || "B√†n";
  table.dataset.max = String(max);

  table.innerHTML = `
    <div class="table-header">
      <h3 class="table-title"></h3>
      <div class="table-actions">
        <button class="quick-add-btn">‚ûï</button>
        <button class="edit-table-btn">‚úèÔ∏è</button>
        <button class="delete-table-btn">üóëÔ∏è</button>
      </div>
    </div>

    <div class="quick-add hidden">
      <input class="quick-add-input" placeholder="Nh·∫≠p t√™n kh√°ch..." />
      <div class="quick-add-hint">Enter ¬∑ Esc</div>
    </div>

    <ul class="guest-list"></ul>
    <div class="table-warning hidden"></div>
  `;

  const list = table.querySelector(".guest-list");

  guests.forEach(name => {
    const li = createGuestLi(name);
    if (li) list.appendChild(li);
  });

  tablesEl.appendChild(table);
  updateTableView(table);
}

/* ---------- READ TABLE DATA ---------- */
function getTableGuests(table) {
  return qsa("li:not(.drag-placeholder)", table.querySelector(".guest-list"));
}

function getTableMax(table) {
  return parseInt(table.dataset.max || "0", 10);
}

function getTableName(table) {
  return normalizeName(table.dataset.baseName || "B√†n");
}
</script>

<script>
/* =====================================================
   MODULE 5 ‚Äî VIEW UPDATE
   ===================================================== */

/* ---------- UPDATE 1 TABLE ---------- */
function updateTableView(table) {
  const list = table.querySelector(".guest-list");
  const guests = qsa("li:not(.drag-placeholder)", list);

  /* Hi·ªÉn th·ªã t√™n ƒë·∫ßy ƒë·ªß */
  guests.forEach(li => {
    setGuestText(li, li.dataset.name);
  });

  const count = guests.length;
  const max   = getTableMax(table);
  const name  = getTableName(table);

  /* Title */
  table.querySelector(".table-title").textContent =
    `${name} (${count}/${max})`;

  /* Over max warning */
  const warning = table.querySelector(".table-warning");

  if (count > max) {
    table.classList.add("over");
    warning.innerHTML = `
      ‚ö†Ô∏è B√†n ƒë√£ d∆∞ ng∆∞·ªùi (${count - max})<br>
      <button class="auto-fix-btn">Auto ƒë∆∞a v·ªÅ Ch∆∞a s·∫Øp x·∫øp</button>
    `;
    warning.classList.remove("hidden");
  } else {
    table.classList.remove("over");
    warning.classList.add("hidden");
    warning.innerHTML = "";
  }

  updateSummaryView();
}

/* ---------- UPDATE SUMMARY ---------- */
function updateSummaryView() {
  qs("#total-tables").textContent =
    qsa(".table").length;

  qs("#total-guests").textContent =
    qsa(".guest-list li:not(.drag-placeholder)").length;
}

/* ---------- UPDATE UNASSIGNED ---------- */
function updateUnassignedView() {
  const list  = unassigned;
  const items = qsa("li:not(.drag-placeholder)", list);
  const count = items.length;

  /* Edit name mode ‚Üí lu√¥n full name */
  if (editNamesMode) {
    items.forEach(li => setGuestText(li, li.dataset.name));
    list.style.display = count < 20 ? "block" : "grid";
    list.style.gridTemplateColumns = count < 20 ? "" : "repeat(2,1fr)";
    return;
  }

  /* B√¨nh th∆∞·ªùng */
  items.forEach(li => setGuestText(li, li.dataset.name));

  if (count < 20) {
    list.style.display = "block";
    list.style.gridTemplateColumns = "";
    return;
  }

  /* R√∫t g·ªçn t√™n khi nhi·ªÅu */
  items.forEach(li => setGuestText(li, shortName(li.dataset.name)));
  list.style.display = "grid";
  list.style.gridTemplateColumns = "repeat(2,1fr)";
}
</script>

<script>
/* =====================================================
   MODULE 6 ‚Äî DRAG & TOUCH (V5.1 FIXED FOR EDIT MODE)
   ===================================================== */

/* ---------- DRAG DESKTOP (Windows / Mac) ---------- */
function getDragAfterElement(container, y) {
  const items = qsa("li:not(.dragging):not(.drag-placeholder)", container);
  return items.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    return (offset < 0 && offset > closest.offset)
      ? { offset, element: child }
      : closest;
  }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
}

/* Desktop drag */
document.addEventListener("dragstart", e => {
  if (interactionMode !== "drag") return;
  if (editNamesMode) return;          // ‚ùó Kh√¥ng drag khi ƒëang s·ª≠a t√™n
  if (isAndroid) return;
  if (e.target.tagName !== "LI") return;

  draggedItem = e.target;
  draggedItem.classList.add("dragging");
  e.dataTransfer.setData("", "");
});

document.addEventListener("dragover", e => {
  if (interactionMode !== "drag") return;
  if (editNamesMode) return;          // ‚ùó Kh√¥ng drag khi ƒëang s·ª≠a t√™n
  if (isAndroid) return;

  const list = e.target.closest(".guest-list");
  if (!list || !draggedItem) return;

  e.preventDefault();

  const after = getDragAfterElement(list, e.clientY);
  after
    ? list.insertBefore(dragPlaceholder, after)
    : list.appendChild(dragPlaceholder);
});

document.addEventListener("drop", e => {
  if (interactionMode !== "drag") return;
  if (editNamesMode) return;          // ‚ùó Kh√¥ng drop khi ƒëang s·ª≠a t√™n
  if (isAndroid) return;

  const list = e.target.closest(".guest-list");
  if (!list || !draggedItem) return;

  e.preventDefault();

  list.insertBefore(draggedItem, dragPlaceholder);
  dragPlaceholder.remove();
  draggedItem.classList.remove("dragging");
  draggedItem = null;

  qsa(".table").forEach(updateTableView);
  saveState();
  setTimeout(updateUnassignedView, 0);
});

document.addEventListener("dragend", () => {
  dragPlaceholder.remove();
  setTimeout(updateUnassignedView, 0);
});


/* ---------- TOUCH DRAG (Windows Touch ONLY) ---------- */
if (isTouch && !isAndroid) {
  let touchItem = null;
  let touchClone = null;
  let timer = null;

  document.addEventListener("touchstart", e => {
    if (interactionMode !== "drag") return;
    if (editNamesMode) return;        // ‚ùó Kh√¥ng drag khi ƒëang s·ª≠a t√™n

    const li = e.target.closest(".guest-list li");
    if (!li) return;

    timer = setTimeout(() => {
      touchItem = li;

      const r = li.getBoundingClientRect();
      touchClone = li.cloneNode(true);
      touchClone.classList.add("touch-dragging");
      touchClone.style.width = r.width + "px";

      document.body.appendChild(touchClone);

      dragPlaceholder.style.height = r.height + "px";
      li.parentElement.insertBefore(dragPlaceholder, li);
      li.style.visibility = "hidden";
    }, 200);
  }, { passive: false });

  document.addEventListener("touchmove", e => {
    if (interactionMode !== "drag") return;
    if (editNamesMode) return;        // ‚ùó Kh√¥ng drag khi ƒëang s·ª≠a t√™n

    if (timer) { clearTimeout(timer); timer = null; }
    if (!touchItem || !touchClone) return;

    e.preventDefault();

    const t = e.touches[0];
    touchClone.style.left = t.clientX - touchClone.offsetWidth / 2 + "px";
    touchClone.style.top  = t.clientY - touchClone.offsetHeight / 2 + "px";

    const el = document.elementFromPoint(t.clientX, t.clientY);
    const list = el?.closest(".guest-list");
    if (!list) return;

    const after = getDragAfterElement(list, t.clientY);
    after
      ? list.insertBefore(dragPlaceholder, after)
      : list.appendChild(dragPlaceholder);
  }, { passive: false });

  document.addEventListener("touchend", () => {
    if (interactionMode !== "drag") return;
    if (editNamesMode) return;        // ‚ùó Kh√¥ng drop khi ƒëang s·ª≠a t√™n

    if (!touchItem) return;

    dragPlaceholder.parentElement.insertBefore(touchItem, dragPlaceholder);
    touchItem.style.visibility = "";

    dragPlaceholder.remove();
    if (touchClone) touchClone.remove();

    touchItem = null;
    touchClone = null;

    qsa(".table").forEach(updateTableView);
    saveState();
    setTimeout(updateUnassignedView, 0);
  });
}
</script>




<script>
/* =====================================================
   MODULE 7 ‚Äî MODES (DELETE / EDIT NAME)
   ===================================================== */

/* ---------- DELETE MODE ---------- */
const deleteBtn        = qs("#delete-mode-btn");
const deleteConfirmBtn = qs("#delete-confirm-btn");
const deleteCancelBtn  = qs("#delete-cancel-btn");

deleteBtn.onclick = () => {
  deleteMode = true;
  document.body.classList.add("delete-mode");

  deleteBtn.classList.add("hidden");
  deleteConfirmBtn.classList.remove("hidden");
  deleteCancelBtn.classList.remove("hidden");

  qsa(".guest-list li:not(.drag-placeholder)").forEach(li => {
    if (!li.querySelector(".delete-x")) {
      const x = document.createElement("span");
      x.textContent = "‚úñ";
      x.className = "delete-x";
      li.appendChild(x);
    }
    li.classList.remove("marked-delete");
  });
};

deleteCancelBtn.onclick = () => {
  deleteMode = false;
  document.body.classList.remove("delete-mode");

  deleteBtn.classList.remove("hidden");
  deleteConfirmBtn.classList.add("hidden");
  deleteCancelBtn.classList.add("hidden");

  qsa(".delete-x").forEach(x => x.remove());
  qsa(".marked-delete").forEach(li => li.classList.remove("marked-delete"));
};

deleteConfirmBtn.onclick = () => {
  if (!confirm("X√≥a c√°c kh√°ch m·ªùi ƒë√£ ch·ªçn?")) return;

  qsa(".marked-delete").forEach(li => li.remove());
  deleteCancelBtn.onclick();

  qsa(".table").forEach(updateTableView);
  saveState();
  updateUnassignedView();
};

/* Click d·∫•u X */
document.addEventListener("click", e => {
  if (!deleteMode) return;
  if (e.target.classList.contains("delete-x")) {
    e.target.closest("li").classList.toggle("marked-delete");
  }
});


/* =====================================================
   EDIT NAME MODE
   ===================================================== */

let originalNames = new Map();

const editBtn    = qs("#edit-names-btn");
const editSave   = qs("#edit-names-save");
const editCancel = qs("#edit-names-cancel");
const toolbarBlocker = qs("#toolbar-blocker");

editBtn.onclick = () => {
  editNamesMode = true;
  document.body.classList.add("edit-names-mode");
  toolbarBlocker.style.pointerEvents = "auto";

  editBtn.classList.add("hidden");
  editSave.classList.remove("hidden");
  editCancel.classList.remove("hidden");

  originalNames.clear();
  qsa(".guest-list li").forEach(li => {
    originalNames.set(li, li.dataset.name);

    const span = li.querySelector(".guest-name");
    if (span) span.contentEditable = "true";

    li.draggable = false; // t·∫Øt drag trong edit mode
  });

  updateUnassignedView();
};

editCancel.onclick = () => {
  originalNames.forEach((oldName, li) => {
    li.dataset.name = oldName;

    // Hi·ªÉn th·ªã ƒë√∫ng theo khu v·ª±c
    if (li.parentElement === unassigned) {
      const many = qsa("#unassigned li:not(.drag-placeholder)").length > 20;
      setGuestText(li, many ? shortName(oldName) : oldName);
    } else {
      setGuestText(li, oldName);
    }

    const span = li.querySelector(".guest-name");
    if (span) span.contentEditable = "false";
  });

  exitEditNameMode(false);
};

editSave.onclick = () => {
  qsa(".guest-list li").forEach(li => {
    const span = li.querySelector(".guest-name");
    if (!span) return;

    const newName = normalizeName(span.textContent);
    li.dataset.name = newName;

    // Hi·ªÉn th·ªã ƒë√∫ng theo khu v·ª±c
    if (li.parentElement === unassigned) {
      const many = qsa("#unassigned li:not(.drag-placeholder)").length > 20;
      setGuestText(li, many ? shortName(newName) : newName);
    } else {
      setGuestText(li, newName);
    }

    span.contentEditable = "false";
  });

  exitEditNameMode(true);
};

function exitEditNameMode(save) {
  editNamesMode = false;
  document.body.classList.remove("edit-names-mode");
  toolbarBlocker.style.pointerEvents = "none";

  qsa(".guest-list li").forEach(li => {
    li.draggable = !isAndroid; // b·∫≠t l·∫°i drag
  });

  editBtn.classList.remove("hidden");
  editSave.classList.add("hidden");
  editCancel.classList.add("hidden");

  qsa(".table").forEach(updateTableView);
  updateUnassignedView();
  if (save) saveState();
}
</script>


<script>
/* =====================================================
   MODULE 8 ‚Äî PERSISTENCE (SAVE / LOAD / CLEAR)
   ===================================================== */

const STORAGE_KEY = "wedding_state";

/* ---------- SAVE ---------- */
function saveState() {

  /* =====================================================
     V5.1 ‚Äî Thu th·∫≠p d·ªØ li·ªáu b√†n & kh√°ch
     ===================================================== */
  const state = {
    tables: qsa(".table").map(t => ({
      name: t.dataset.baseName,
      max:  t.dataset.max,
      guests: qsa("li:not(.drag-placeholder)", t.querySelector(".guest-list"))
        .map(li => li.dataset.name)
    })),

    // Danh s√°ch kh√°ch ch∆∞a x·∫øp
    unassigned: qsa("li:not(.drag-placeholder)", unassigned)
      .map(li => li.dataset.name),

    /* =====================================================
       V5.1 ‚Äî L∆∞u Interaction Mode (Tap / Drag)
       ƒê√¢y l√† ph·∫ßn m·ªõi th√™m v√†o so v·ªõi V5.0
       ===================================================== */
    interactionMode: interactionMode
  };

  /* =====================================================
     L∆∞u to√†n b·ªô state v√†o localStorage
     ===================================================== */
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

/* ---------- LOAD ---------- */
function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);

  // N·∫øu ch∆∞a c√≥ d·ªØ li·ªáu ‚Üí t·∫°o b√†n m·∫∑c ƒë·ªãnh
  if (!raw) {
    createTable("B√†n 1");
    updateSummaryView();
    return;
  }

  let state;
  try {
    state = JSON.parse(raw);
  } catch (e) {
    console.error("L·ªói parse state, reset d·ªØ li·ªáu", e);
    localStorage.removeItem(STORAGE_KEY);
    createTable("B√†n 1");
    updateSummaryView();
    return;
  }

  // N·∫øu d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá ‚Üí t·∫°o b√†n m·∫∑c ƒë·ªãnh
  if (!Array.isArray(state.tables)) {
    createTable("B√†n 1");
    updateSummaryView();
    return;
  }

  // =====================================================
  // V5.1 ‚Äî Load Interaction Mode (Tap / Drag)
  // N·∫øu c√≥ l∆∞u mode tr∆∞·ªõc ƒë√≥ ‚Üí kh√¥i ph·ª•c
  // =====================================================
  if (state.interactionMode) {
    interactionMode = state.interactionMode;
  }

  // T·∫°o l·∫°i c√°c b√†n t·ª´ state
  state.tables.forEach(t =>
    createTable(t.name, t.max, t.guests || [])
  );

  // T·∫°o l·∫°i danh s√°ch kh√°ch ch∆∞a x·∫øp
  (state.unassigned || []).forEach(name => {
    const li = createGuestLi(name);
    if (li) unassigned.appendChild(li);
  });

  // C·∫≠p nh·∫≠t giao di·ªán b√†n
  qsa(".table").forEach(updateTableView);

  // C·∫≠p nh·∫≠t danh s√°ch ch∆∞a x·∫øp
  updateUnassignedView();

  // =====================================================
  // V5.1 ‚Äî √Åp d·ª•ng Interaction Mode sau khi load
  // (ƒë·ªÉ UI v√† logic kh·ªõp v·ªõi mode ƒë√£ l∆∞u)
  // =====================================================
  applyInteractionMode();
}

/* ---------- CLEAR ---------- */
qs("#save-btn").onclick = () => {
  saveState();
  alert("ƒê√£ l∆∞u!");
};

qs("#clear-btn").onclick = () => {
  if (confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu?")) {
    localStorage.removeItem(STORAGE_KEY);
    location.reload();
  }
};

/* ---------- AUTO LOAD ---------- */
loadState();
</script>

<script>
/* =====================================================
   MODULE 9 ‚Äî IMPORT / EXPORT / PDF
   ===================================================== */

/* ---------- IMPORT CSV ---------- */
qs("#import-btn").onclick = () => {
  qs("#import-csv").click();
};

qs("#import-csv").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => parseCSV(reader.result);
  reader.readAsText(file, "utf-8");
  e.target.value = "";
});

function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  if (lines.length < 2) return alert("CSV kh√¥ng h·ª£p l·ªá");

  const headers = lines[0].split(",").map(h => h.trim().toLowerCase());
  const idxName  = headers.indexOf("t√™n kh√°ch");
  const idxTable = headers.indexOf("b√†n");

  if (idxName === -1) return alert("CSV ph·∫£i c√≥ c·ªôt 'T√™n kh√°ch'");

  lines.slice(1).forEach(line => {
    const cols = line.split(",").map(c => stripQuotes(c));
    const name = normalizeName(cols[idxName]);
    if (!name) return;

    if (idxTable !== -1 && cols[idxTable]) {
      const tableName = normalizeName(cols[idxTable]);
      let table = qsa(".table")
        .find(t => t.dataset.baseName === tableName);

      if (!table) {
        createTable(tableName);
        table = qsa(".table")
          .find(t => t.dataset.baseName === tableName);
      }

      table.querySelector(".guest-list")
        .appendChild(createGuestLi(name));
      updateTableView(table);
    } else {
      unassigned.appendChild(createGuestLi(name));
    }
  });

  saveState();
  updateSummaryView();
  updateUnassignedView();
}

/* ---------- EXPORT MENU ---------- */
exportBtn.onclick = () => {
  exportMenu.style.display =
    exportMenu.style.display === "flex" ? "none" : "flex";
};

document.addEventListener("click", e => {
  if (
    !exportMenu.contains(e.target) &&
    e.target !== exportBtn &&
    !e.target.closest(".modal")
  ) {
    exportMenu.style.display = "none";
  }
});

/* ---------- EXPORT CSV ---------- */
qs("#export-csv").onclick = () => {
  exportMenu.style.display = "none";

  const rows = [["T√™n kh√°ch", "B√†n"]];

  qsa(".table").forEach(t => {
    const tableName = t.dataset.baseName;
    qsa("li:not(.drag-placeholder)", t.querySelector(".guest-list"))
      .forEach(li => rows.push([li.dataset.name, tableName]));
  });

  qsa("li:not(.drag-placeholder)", unassigned)
    .forEach(li => rows.push([li.dataset.name, ""]));

  const csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "danhsach.csv";
  a.click();
};

/* ---------- EXPORT PDF ALL (C2) ---------- */
qs("#export-pdf-all").onclick = () => {
  exportMenu.style.display = "none";
  const w = window.open("", "_blank");

  const css = `
    <style>
      body { font-family: "Times New Roman", serif; margin:0; padding:0 }
      .page {
        padding:40px 30px;
        page-break-after:always;
        border:2px solid #000;
        margin:20px;
      }
      h1 { text-align:center; font-size:32px; margin-bottom:20px }
      ul { list-style:none; padding:0; font-size:20px; line-height:1.6 }
      ul li::before { content:"‚Ä¢ "; font-size:24px }
    </style>
  `;

  w.document.write("<html><head>" + css + "</head><body>");

  w.document.write(`<div class="page"><h1>CH∆ØA S·∫ÆP X·∫æP</h1><ul>`);
  qsa("li:not(.drag-placeholder)", unassigned)
    .forEach(li => w.document.write(`<li>${li.dataset.name}</li>`));
  w.document.write("</ul></div>");

  qsa(".table").forEach(t => {
    w.document.write(`<div class="page"><h1>${t.dataset.baseName}</h1><ul>`);
    qsa("li:not(.drag-placeholder)", t.querySelector(".guest-list"))
      .forEach(li => w.document.write(`<li>${li.dataset.name}</li>`));
    w.document.write("</ul></div>");
  });

  w.document.write("</body></html>");
  w.document.close();
  w.print();
};

/* ---------- EXPORT PDF ONE (C2) ---------- */
qs("#export-pdf-one").onclick = () => {
  exportMenu.style.display = "none";
  pdfTableSelect.innerHTML = "";

  qsa(".table").forEach((t, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = t.dataset.baseName;
    pdfTableSelect.appendChild(opt);
  });

  pdfOneModal.style.display = "flex";
};

qs("#pdf-one-cancel").onclick = () => {
  pdfOneModal.style.display = "none";
};

qs("#pdf-one-export").onclick = () => {
  const table = qsa(".table")[pdfTableSelect.value];
  const w = window.open("", "_blank");

  const css = `
    <style>
      body { font-family:"Times New Roman", serif; margin:0 }
      .page {
        padding:40px 30px;
        border:2px solid #000;
        margin:20px;
      }
      h1 { text-align:center; font-size:32px; margin-bottom:20px }
      ul { list-style:none; padding:0; font-size:20px; line-height:1.6 }
      ul li::before { content:"‚Ä¢ "; font-size:24px }
    </style>
  `;

  w.document.write("<html><head>" + css + "</head><body>");
  w.document.write(`<div class="page"><h1>${table.dataset.baseName}</h1><ul>`);

  qsa("li:not(.drag-placeholder)", table.querySelector(".guest-list"))
    .forEach(li => w.document.write(`<li>${li.dataset.name}</li>`));

  w.document.write("</ul></div></body></html>");
  w.document.close();
  w.print();
  pdfOneModal.style.display = "none";
};
</script>

<script>
/* =====================================================
   MODULE 10 ‚Äî UI ACTIONS & TABLE OPERATIONS
   ===================================================== */

/* ---------- ADD TABLE ---------- */
qs("#add-table").onclick = () => {
  const count = qsa(".table").length + 1;
  createTable("B√†n " + count);
  updateSummaryView();
  saveState();
};

/* ---------- ADJUST MAX ---------- */
qs("#adjust-max").onclick = () => {
  maxList.innerHTML = "";

  qsa(".table").forEach((t, i) => {
    const row = document.createElement("div");
    row.className = "max-row";
    row.style.marginBottom = "8px";

    row.innerHTML = `
      <div style="margin-bottom:4px;font-weight:600">${t.dataset.baseName}</div>
      <input type="number" class="max-input" data-index="${i}"
        value="${t.dataset.max}"
        style="width:100%;padding:6px;border-radius:6px;border:1px solid #ccc">
    `;
    maxList.appendChild(row);
  });

  maxModal.style.display = "flex";
};

qs("#max-cancel").onclick = () => {
  maxModal.style.display = "none";
};

qs("#max-save").onclick = () => {
  qsa(".max-input", maxList).forEach(inp => {
    const idx = parseInt(inp.dataset.index, 10);
    const val = parseInt(inp.value || "0", 10);
    if (val > 0 && qsa(".table")[idx]) {
      qsa(".table")[idx].dataset.max = String(val);
      updateTableView(qsa(".table")[idx]);
    }
  });

  const bulk = qs("#bulk-max");
  if (bulk && bulk.value) {
    const v = parseInt(bulk.value, 10);
    if (v > 0) {
      qsa(".table").forEach(t => {
        t.dataset.max = String(v);
        updateTableView(t);
      });
    }
  }

  saveState();
  maxModal.style.display = "none";
};

  
/* ---------- MOVE GUEST MODAL (V5.1 FULL VERSION) ---------- */
function openMoveGuestModal(li) {
  const currentList = li.parentElement;
  const siblings = Array.from(currentList.querySelectorAll("li:not(.drag-placeholder)"));
  const index = siblings.indexOf(li);
  const isInUnassigned = (currentList === unassigned);

  const grid = qs(".move-grid");
  const leftCol = qs(".move-column-left");

  const btnTop = qs(".move-top");
  const btnUp = qs(".move-up");
  const btnDown = qs(".move-down");
  const btnBottom = qs(".move-bottom");

  /* ====== 0) Reset tr·∫°ng th√°i n√∫t & layout ====== */
  [btnTop, btnUp, btnDown, btnBottom].forEach(b => b.classList.remove("disabled"));
  leftCol.style.display = "";
  grid.classList.remove("single-column");

  /* ====== 1) N·∫øu kh√°ch ƒëang ·ªü 'Ch∆∞a s·∫Øp x·∫øp' ====== */
  if (isInUnassigned) {
    // ·∫®n ho√†n to√†n c·ªôt "Trong b√†n"
    leftCol.style.display = "none";
    grid.classList.add("single-column");
  } else {
    // C·ªôt tr√°i v·∫´n d√πng ‚Üí ki·ªÉm tra v·ªã tr√≠ & s·ªë l∆∞·ª£ng
    // N·∫øu ch·ªâ c√≥ 1 t√™n trong b√†n ‚Üí m·ªù h·∫øt 4 n√∫t
    if (siblings.length <= 1) {
      [btnTop, btnUp, btnDown, btnBottom].forEach(b => b.classList.add("disabled"));
    } else {
      // M·ªù n√∫t l√™n 1 v·ªã tr√≠ n·∫øu ƒëang ·ªü ƒë·∫ßu
      if (index === 0) {
        btnUp.classList.add("disabled");
        btnTop.classList.add("disabled");
      }
      // M·ªù n√∫t xu·ªëng 1 v·ªã tr√≠ n·∫øu ƒëang ·ªü cu·ªëi
      if (index === siblings.length - 1) {
        btnDown.classList.add("disabled");
        btnBottom.classList.add("disabled");
      }
    }

    // G√°n h√†nh vi cho 4 n√∫t trong b√†n
    btnTop.onclick = () => {
      if (btnTop.classList.contains("disabled")) return;
      currentList.insertBefore(li, siblings[0]);
      finalizeMove();
    };

    btnUp.onclick = () => {
      if (btnUp.classList.contains("disabled")) return;
      if (index > 0) {
        currentList.insertBefore(li, siblings[index - 1]);
        finalizeMove();
      }
    };

    btnDown.onclick = () => {
      if (btnDown.classList.contains("disabled")) return;
      if (index < siblings.length - 1) {
        currentList.insertBefore(li, siblings[index + 2] || null);
        finalizeMove();
      }
    };

    btnBottom.onclick = () => {
      if (btnBottom.classList.contains("disabled")) return;
      currentList.appendChild(li);
      finalizeMove();
    };
  }

  /* ====== 2) T·∫°o danh s√°ch b√†n kh√°c ====== */
  const box = qs("#move-list");
  box.innerHTML = "";

  // N·∫øu KH√îNG ·ªü 'Ch∆∞a s·∫Øp x·∫øp' ‚Üí cho ph√©p chuy·ªÉn v·ªÅ 'Ch∆∞a s·∫Øp x·∫øp'
  if (!isInUnassigned) {
    const unBtn = document.createElement("button");
    unBtn.className = "btn unassigned-btn";
    unBtn.textContent = "Ch∆∞a s·∫Øp x·∫øp";
    unBtn.onclick = () => {
      unassigned.appendChild(li);
      finalizeMove();
    };
    box.appendChild(unBtn);
  }

  // Th√™m c√°c b√†n kh√°c
  qsa(".table").forEach(t => {
    const list = t.querySelector(".guest-list");
    // Lo·∫°i tr·ª´ b√†n hi·ªán t·∫°i (n·∫øu kh√¥ng ph·∫£i unassigned)
    if (!isInUnassigned && list === currentList) return;

    const btn = document.createElement("button");
    btn.className = "btn";
    btn.textContent = t.dataset.baseName;

    btn.onclick = () => {
      list.appendChild(li);
      finalizeMove();
    };

    box.appendChild(btn);
  });

  /* ====== 3) Hi·ªÉn th·ªã modal ====== */
  qs("#move-modal").style.display = "flex";

  /* ====== 4) N√∫t ƒë√≥ng ====== */
  qs("#move-cancel").onclick = () => {
    qs("#move-modal").style.display = "none";
  };

  /* ====== 5) H√†m c·∫≠p nh·∫≠t sau khi di chuy·ªÉn ====== */
  function finalizeMove() {
    qs("#move-modal").style.display = "none";
    qsa(".table").forEach(updateTableView);
    updateUnassignedView();
    updateSummaryView();
    saveState();
  }
}


  


/* ---------- TABLE ACTIONS ---------- */
tablesEl.addEventListener("click", e => {
  const table = e.target.closest(".table");
  if (!table) return;

  /* Delete table */
  if (e.target.classList.contains("delete-table-btn")) {
    if (!confirm("X√≥a b√†n n√†y?")) return;

    qsa("li:not(.drag-placeholder)", table.querySelector(".guest-list"))
      .forEach(li => unassigned.appendChild(li));

    updateUnassignedView();
    table.remove();
    updateSummaryView();
    saveState();
  }

  /* Rename table */
  if (e.target.classList.contains("edit-table-btn")) {
    const newName = prompt("T√™n b√†n:", table.dataset.baseName);
    if (newName) {
      table.dataset.baseName = normalizeName(newName);
      updateTableView(table);
      saveState();
    }
  }

  /* Quick add */
  let currentTableForQuickAdd = null;

document.addEventListener("click", e => {
  const btn = e.target.closest(".quick-add-btn");
  if (!btn) return;

  const table = btn.closest(".table");
  if (!table) return;

  currentTableForQuickAdd = table;
  qs("#quick-add-input").value = "";
  qs("#quick-add-modal").style.display = "flex";
  qs("#quick-add-input").focus();
});

qs("#quick-add-cancel").onclick = () => {
  qs("#quick-add-modal").style.display = "none";
  currentTableForQuickAdd = null;
};

qs("#quick-add-confirm").onclick = () => {
  const name = normalizeName(qs("#quick-add-input").value);
  if (!name) return;

  const ul = currentTableForQuickAdd.querySelector(".guest-list");
  if (!ul) return;

  const li = createGuestLi(name);
  ul.appendChild(li);

  qs("#quick-add-modal").style.display = "none";
  currentTableForQuickAdd = null;

  updateTableView();
  saveState();
};


  /* Auto fix */
  if (e.target.classList.contains("auto-fix-btn")) {
    const list = table.querySelector(".guest-list");
    const max = getTableMax(table);
    const items = qsa("li:not(.drag-placeholder)", list);

    while (items.length > max) {
      unassigned.appendChild(items.pop());
    }

    updateTableView(table);
    updateUnassignedView();
    saveState();
  }
});

/* ---------- HELP ---------- */
qs("#help-btn").onclick = () => {
  qs("#help-modal").style.display = "flex";
};

qs("#help-close").onclick = () => {
  qs("#help-modal").style.display = "none";
};
  
/* ---------- QUICK ADD GUEST (SIDEBAR) ---------- */
qs("#add-guest").onclick = () => {
  const text = guestInput.value.trim();
  if (!text) return;

  const names = text
    .split(/\n+/)
    .map(n => normalizeName(n))
    .filter(Boolean);

  names.forEach(name => {
    const li = createGuestLi(name);
    if (li) unassigned.appendChild(li);
  });

  guestInput.value = "";
  applyInteractionMode();
  updateUnassignedView();

  updateSummaryView();
  saveState();
};

/* =====================================================
   V5.1 ‚Äî Toggle Tap / Drag Mode (Slider)
   ===================================================== */

const toggle = document.getElementById("interaction-toggle");
if (toggle) {
  const buttons = toggle.querySelectorAll(".toggle-btn");
  const thumb = toggle.querySelector(".toggle-thumb");

  function updateToggleUI() {
    buttons.forEach(btn => btn.classList.remove("active"));
    const activeBtn = toggle.querySelector(`[data-mode="${interactionMode}"]`);
    activeBtn.classList.add("active");

    // Di chuy·ªÉn thumb
    if (interactionMode === "tap") {
      thumb.style.left = "3px";
    } else {
      thumb.style.left = "calc(50% + 3px)";
    }
  }

  buttons.forEach(btn => {
    btn.addEventListener("click", () => {
      interactionMode = btn.dataset.mode;
      saveState();
      applyInteractionMode();
      updateToggleUI();
    });
  });

  // Kh·ªüi t·∫°o UI khi load trang
  updateToggleUI();
}

/* =====================================================
   V5.1 ‚Äî TAP MODE (ICON-BASED)
   ===================================================== */

function handleMoveClick(e) {
  if (interactionMode !== "tap") return;

  const moveBtn = e.target.closest(".move-btn");
  if (!moveBtn) return;

  const li = moveBtn.closest("li");
  if (!li) return;

  openMoveGuestModal(li);
}

// Click trong khu v·ª±c b√†n
tablesEl.addEventListener("click", handleMoveClick);

// Click trong khu v·ª±c "Ch∆∞a s·∫Øp x·∫øp"
unassigned.addEventListener("click", handleMoveClick);

</script>


</body>
</html>
