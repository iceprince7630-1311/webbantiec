<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8">
<title>S·∫Øp x·∫øp b√†n ti·ªác</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
*{box-sizing:border-box}
body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#f4f6fb;color:#111}

/* Layout */
.layout{display:grid;grid-template-columns:4fr 1.2fr;height:100vh;gap:12px;padding:12px}

/* Toolbar */
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer;font-weight:bold}
.btn:hover{background:#eee}
#add-table{font-size:22px;background:#111;color:#fff;border:none}
#clear-btn{border-color:#dc2626;color:#dc2626}
#clear-btn:hover{background:#dc2626;color:#fff}

/* Summary */
#summary{margin-left:auto;font-weight:bold}

/* Export */
.export-menu{position:relative}
.export-dropdown{
  position:absolute;top:110%;left:0;
  background:#fff;border:1px solid #ccc;border-radius:10px;
  padding:6px;display:none;flex-direction:column;gap:4px;
  z-index:10;min-width:200px
}
.export-dropdown button{text-align:left}

/* Tables */
.tables{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:12px;overflow:auto;margin-top:10px}
.table{background:#fff;border-radius:12px;padding:10px;border:1px solid #ddd;display:flex;flex-direction:column}
.table.over{background:#fee2e2;border:2px solid #dc2626}

/* Color accents */
.table:nth-child(4n+1){border-top:4px solid #2563eb}
.table:nth-child(4n+2){border-top:4px solid #16a34a}
.table:nth-child(4n+3){border-top:4px solid #f59e0b}
.table:nth-child(4n+4){border-top:4px solid #dc2626}

.table-header{display:flex;justify-content:space-between;align-items:center;gap:6px;padding-bottom:6px;border-bottom:1px solid #eee}
.table-title{margin:0;font-size:15px;outline:none}
.table-actions{display:flex;gap:4px}
.table-actions button{padding:6px 8px;border-radius:8px;border:1px solid #ccc;background:#fff;cursor:pointer}

/* Guest list */
.guest-list{
  list-style:none;padding:6px;margin:8px 0;
  border:2px dashed #ccc;min-height:80px;border-radius:8px;
  counter-reset:guest;
}
.guest-list li{
  background:#fff;border:1px solid #ccc;border-radius:6px;
  padding:6px;margin-bottom:4px;cursor:grab;position:relative;
  user-select:none;
}
.guest-list li:not(.drag-placeholder)::before{
  counter-increment:guest;
  content: counter(guest) ".";
  display:inline-block;
  min-width:28px;
  margin-right:6px;
  color:#555;
  font-weight:bold;
}

/* Drag UI */
.drag-placeholder{
  height:32px;
  margin-bottom:4px;
  border:2px dashed #2563eb;
  border-radius:6px;
  background:rgba(37,99,235,.08);
}
.dragging{opacity:.4}

/* Touch drag */
@media (pointer: coarse){
  .guest-list li{touch-action:none}
}
.touch-dragging{
  position:fixed;
  z-index:10000;
  pointer-events:none;
  opacity:.85;
  transform:scale(1.05);
  box-shadow:0 8px 20px rgba(0,0,0,.25);
  background:#fef3c7;
}

/* Drop hints */
.table.can-drop{outline:3px solid #16a34a}
.table.cannot-drop{outline:3px solid #dc2626}

/* Warning */
.table-warning{margin-top:6px;padding:8px;border-radius:8px;background:#fee2e2;color:#991b1b;font-size:13px}

/* Sidebar layout */
.sidebar {
  display: flex;
  flex-direction: column;
  gap: 12px;
  height: 100%;
  overflow: hidden;
}

/* CH∆ØA S·∫ÆP X·∫æP */
#unassigned-wrapper {
  flex: 1;
  overflow-y: auto;
  padding-right: 6px;
  background: #fff;
  border-radius: 12px;
  border: 1px solid #ddd;
  display: flex;
  flex-direction: column;
}

#unassigned-wrapper-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px;
  border-bottom: 1px solid #eee;
  background: #fafafa;
  position: sticky;
  top: 0;
  z-index: 10;
}

#unassigned {
  padding: 10px;
  margin: 0;
  flex: 1;
}

/* TH√äM KH√ÅCH (sticky bottom) */
.quick-add {
  position: sticky;
  bottom: 0;
  background: #fff;
  z-index: 20;
  border-top: 1px solid #ddd;
  padding-top: 14px;
  padding-bottom: 14px;
}

textarea{width:100%;height:120px;border-radius:8px;padding:8px}

/* Modal */
.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;z-index:100}
.modal-content{background:#fff;padding:16px;border-radius:14px;width:360px;max-width:90vw}
.modal-actions{display:flex;justify-content:flex-end;gap:8px;margin-top:14px}

/* Print */
@media print{
  .layout{display:none!important}
  #print-root{display:block!important}
  .table-actions,.quick-add,.table-warning{display:none!important}
  .table{page-break-inside:avoid}
  .table + .table{page-break-before:always}
  .table-title{font-size:18px}
  @page{size:A4;margin:10mm}
}
#print-root{
  position:fixed;inset:0;background:#fff;z-index:9999;
  display:none;overflow:auto;padding:12px
}

/* Mobile spacing */
@media (max-width:768px){
  .btn{padding:10px 14px}
  #add-table{font-size:26px}
  .table{padding:12px}
}

.delete-x{
  position:absolute;
  right:6px;
  top:4px;
  font-size:12px;
  cursor:pointer;
  color:#dc2626;
  display:none;
}
.delete-mode li .delete-x{display:block}
.marked-delete{opacity:.4;text-decoration:line-through}

.edit-names-mode li {
  cursor: text !important;
  background: #fff7d6;
}
.edit-names-mode .guest-list li.dragging {
  opacity: 1 !important;
}

#toolbar-blocker {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 60px;
  background: rgba(255,255,255,0.5);
  backdrop-filter: blur(2px);
  z-index: 900;
  display: none;
  pointer-events: auto;
}

.edit-only {
  position: relative;
  z-index: 1001;
}

/* ============================
   SIDEBAR FIX & OPTIMIZATION
   ============================ */

/* Gi·ªØ nguy√™n layout sidebar c≈©, ch·ªâ th√™m scroll */
.sidebar {
  display: flex;
  flex-direction: column;
  gap: 12px;
  height: 100%;
  overflow: hidden; /* ƒë·ªÉ ph·∫ßn d∆∞·ªõi scroll */
}

/* --- CH∆ØA S·∫ÆP X·∫æP: scroll ƒë·ªôc l·∫≠p --- */
#unassigned-wrapper {
  flex: 1;
  overflow-y: auto;
  padding-right: 6px;
  border-radius: 12px;
}

/* Header c·ªë ƒë·ªãnh khi scroll */
#unassigned-wrapper-header {
  position: sticky;
  top: 0;
  background: #fff;
  padding: 10px;
  border-bottom: 1px solid #eee;
  z-index: 5;
}

/* --- TH√äM KH√ÅCH: t·ªëi ∆∞u cho Android --- */
.quick-add {
  background: #fff;
  border-radius: 12px;
  border: 1px solid #ddd;
  padding: 10px;
  margin-top: 8px;

  /* KH√îNG d√πng sticky v√¨ Android x·ª≠ l√Ω r·∫•t t·ªá */
  position: relative;
}

/* Textarea t·ªëi ∆∞u cho mobile */
.quick-add textarea {
  height: 90px;
  max-height: 140px;
  resize: vertical;
}

/* ƒê·∫£m b·∫£o n√∫t ·∫©n th·ª±c s·ª± ·∫©n */
.hidden {
  display: none !important;
}
/* Sidebar: gi·ªØ layout c·ªôt, KH√îNG d√πng overflow:hidden ƒë·ªÉ kh√¥ng ph√° sticky */
.sidebar {
  display: flex;
  flex-direction: column;
  gap: 12px;
  max-height: 100vh;
}

/* Card "Ch∆∞a s·∫Øp x·∫øp" chi·∫øm ph·∫ßn c√≤n l·∫°i, b√™n trong c√≥ v√πng scroll */
.unassigned-card {
  display: flex;
  flex-direction: column;
  flex: 1;
  min-height: 0; /* cho ph√©p flex child scroll ƒë√∫ng */
}

/* Header "Ch∆∞a s·∫Øp x·∫øp" */
.unassigned-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 6px;
  padding-bottom: 6px;
  border-bottom: 1px solid #eee;
}

/* V√πng scroll cho danh s√°ch ch∆∞a s·∫Øp x·∫øp */
.unassigned-scroll {
  flex: 1;
  min-height: 0;
  overflow-y: auto;
  padding-right: 4px;
}

/* Th√™m kh√°ch: sticky ·ªü tr√™n, t·ªëi ∆∞u cho Android */
.quick-add {
  position: sticky;
  top: 0;
  z-index: 10;
  background: #fff;
}

/* Textarea Th√™m kh√°ch: chi·ªÅu cao v·ª´a ph·∫£i tr√™n mobile */
.quick-add textarea {
  height: 90px;
  max-height: 140px;
  resize: vertical;
}

/* ƒê·∫£m b·∫£o n√∫t hidden th·ª±c s·ª± ·∫©n (fix v·ª• n√∫t l·ªô ra) */
.hidden {
  display: none !important;
}
  
/* -------------------------------------------------------------------------------------------------------------------------------------- */ 
</style>

<link type="text/css" rel="stylesheet" href="css/style.css"/>
  
</head>

<body>

<body>

<div class="layout">

  <div>
    <div class="toolbar">
      <button id="add-table">+</button>
      <button id="adjust-max" class="btn">‚öôÔ∏è Ch·ªânh max</button>
      
      <button id="edit-names-btn" class="btn edit-only">‚úèÔ∏è S·ª≠a t√™n kh√°ch</button>
      <button id="edit-names-save" class="btn hidden edit-only">üíæ ƒê·ªìng √Ω</button>
      <button id="edit-names-cancel" class="btn hidden edit-only">‚ùå H·ªßy</button>

      <button id="save-btn" class="btn">üíæ L∆∞u</button>
      <button id="clear-btn" class="btn">üßπ X√≥a</button>
      <input type="file" id="import-csv" accept=".csv" hidden>
      <button id="import-btn" class="btn">üì• Import CSV</button>
      
      <div class="export-menu">
        <button id="export-btn" class="btn">üì§ Xu·∫•t</button>
        <div id="export-menu" class="export-dropdown">
          <button id="export-csv">üìä Excel (CSV)</button>
          <button id="export-pdf-all">üñ®Ô∏è PDF t·∫•t c·∫£</button>
          <button id="export-pdf-one">üßæ PDF 1 b√†n</button>
        </div>
      </div>

      <button id="help-btn" class="btn">‚ùì H∆∞·ªõng d·∫´n</button>

      <div id="summary">
        T·ªïng: <span id="total-guests">0</span> kh√°ch ¬∑
        <span id="total-tables">0</span> b√†n
      </div>
    </div>

    <div id="toolbar-blocker"></div>

    <div class="tables" id="tables"></div>
  </div>

  <!-- SIDEBAR -->
  <div class="sidebar">

  <!-- TH√äM KH√ÅCH LU√îN TR√äN C√ôNG -->
  <div class="card quick-add">
    <h3>Th√™m kh√°ch</h3>
    <textarea id="guest-input" placeholder="M·ªói d√≤ng l√† 1 t√™n..."></textarea>
    <button id="add-guest" class="btn">Th√™m</button>
  </div>

  <!-- CH∆ØA S·∫ÆP X·∫æP TRONG CARD RI√äNG, C√ì SCROLL -->
  <div class="card unassigned-card">
    <div class="unassigned-header">
      <h3>Ch∆∞a s·∫Øp x·∫øp</h3>
      <div>
        <button id="delete-mode-btn" class="btn">üóëÔ∏è</button>
        <button id="delete-confirm-btn" class="btn hidden">‚úÖ</button>
        <button id="delete-cancel-btn" class="btn hidden">‚ùå</button>
      </div>
    </div>

    <div class="unassigned-scroll">
      <ul class="guest-list" id="unassigned"></ul>
    </div>
  </div>

</div>

<!-- MODALS (gi·ªØ nguy√™n nh∆∞ b·∫°n g·ª≠i) -->
<div class="modal" id="max-modal">
  <div class="modal-content">
    <h3>Ch·ªânh s·ªë kh√°ch t·ªëi ƒëa</h3>
    <div style="margin-bottom:10px">
      <label><b>Ch·ªânh h√†ng lo·∫°t:</b></label>
      <input type="number" id="bulk-max" min="1" placeholder="Nh·∫≠p s·ªë kh√°ch t·ªëi ƒëa..." 
           style="width:100%;padding:6px;border-radius:6px;border:1px solid #ccc;margin-top:4px">
      <div style="font-size:12px;color:#666;margin-top:2px">
      Khi nh·∫≠p s·ªë v√†o ƒë√¢y, t·∫•t c·∫£ b√†n s·∫Ω c√≥ s·ªë kh√°ch t·ªëi ƒëa gi·ªëng nhau.
      </div>
    </div>

    <div id="max-list"></div>
    <div class="modal-actions">
      <button id="max-cancel" class="btn">H·ªßy</button>
      <button id="max-save" class="btn">L∆∞u</button>
    </div>
  </div>
</div>

<div class="modal" id="pdf-one-modal">
  <div class="modal-content">
    <h3>Xu·∫•t PDF 1 b√†n</h3>
    <select id="pdf-table-select" style="width:100%;padding:8px;border-radius:8px"></select>
    <div class="modal-actions">
      <button id="pdf-one-cancel" class="btn">H·ªßy</button>
      <button id="pdf-one-export" class="btn">Xu·∫•t</button>
    </div>
  </div>
</div>

<div class="modal" id="help-modal">
  <div class="modal-content">
    <h3>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
    <div id="help-content" style="max-height:60vh;overflow:auto;line-height:1.5">
      <!-- n·ªôi dung gi·ªØ nguy√™n -->
    </div>
    <div class="modal-actions">
      <button id="help-close" class="btn">Tr·ªü v·ªÅ</button>
    </div>
  </div>
</div>

<div id="print-root"></div>

<script>
/* ================= DOM ================= */
const tablesEl = document.getElementById("tables");
const unassigned = document.getElementById("unassigned");
const guestInput = document.getElementById("guest-input");
const exportBtn = document.getElementById("export-btn");
const exportMenu = document.getElementById("export-menu");
const printRoot = document.getElementById("print-root");

const maxModal = document.getElementById("max-modal");
const maxList = document.getElementById("max-list");

const pdfOneModal = document.getElementById("pdf-one-modal");
const pdfTableSelect = document.getElementById("pdf-table-select");

const isTouch = ("ontouchstart" in window) || (navigator.maxTouchPoints > 0);

let editNamesMode = false;
/* ================= Helpers ================= */
function normalizeName(s){ return String(s||"").trim().replace(/\s+/g," "); }
function createGuestLi(name){
  const clean = normalizeName(name);
  const li = document.createElement("li");
  li.draggable = true;
  li.dataset.name = clean;
  li.textContent = clean;
  return li;
}
function stripQuotes(s){
  return String(s || "").replace(/^"(.*)"$/, "$1").trim();
}
function guestNameFromLi(li){
  return li.dataset.name || normalizeName(li.textContent);
}

/* ================= Shortening Name ================= */
function shortName(full){
  const parts = full.trim().split(/\s+/);
  if(parts.length <= 2) return full;
  return parts.slice(-2).join(" ");
}

/* ================= Update Unassigned View if it's too long ================= */
function updateUnassignedView(){
  const list = document.getElementById("unassigned");
  const items = [...list.querySelectorAll("li:not(.drag-placeholder)")];
  const count = items.length;

  // ‚≠ê N·∫øu ƒëang s·ª≠a t√™n ‚Üí lu√¥n hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß, kh√¥ng r√∫t g·ªçn
  if(editNamesMode){
    items.forEach(li => li.textContent = li.dataset.name);

    if(count < 20){
      list.style.display = "block";
      list.style.gridTemplateColumns = "";
      list.style.maxHeight = "";
      list.style.overflowY = "";
    } else {
      list.style.display = "grid";
      list.style.gridTemplateColumns = "repeat(2, 1fr)";
      list.style.columnGap = "10px";
      list.style.maxHeight = "";
      list.style.overflowY = "";
    }

    return; // ‚≠ê QUAN TR·ªåNG: kh√¥ng ch·∫°y xu·ªëng ph·∫ßn r√∫t g·ªçn
  }

  // ‚≠ê Khi KH√îNG s·ª≠a t√™n ‚Üí reset v·ªÅ t√™n ƒë·∫ßy ƒë·ªß tr∆∞·ªõc
  items.forEach(li => li.textContent = li.dataset.name);

  // N·∫øu d∆∞·ªõi 20 kh√°ch ‚Üí gi·ªØ nguy√™n
  if(count < 20){
    list.style.display = "block";
    list.style.gridTemplateColumns = "";
    list.style.maxHeight = "";
    list.style.overflowY = "";
    return;
  }

  // ‚≠ê R√∫t g·ªçn t√™n khi KH√îNG s·ª≠a t√™n
  items.forEach(li => {
    li.textContent = shortName(li.dataset.name);
  });

  // Lu√¥n 2 c·ªôt
  list.style.display = "grid";
  list.style.gridTemplateColumns = "repeat(2, 1fr)";
  list.style.columnGap = "10px";

  // Scroll n·∫øu > 40 kh√°ch
  if(count > 40){
    list.style.maxHeight = "600px";
    list.style.overflowY = "auto";
  } else {
    list.style.maxHeight = "";
    list.style.overflowY = "";
  }
}

  
/* ================= Summary ================= */
function updateSummary(){
  document.getElementById("total-tables").textContent =
    document.querySelectorAll(".table").length;
  document.getElementById("total-guests").textContent =
    document.querySelectorAll(".guest-list li:not(.drag-placeholder)").length;
}

/* ================= Table ================= */
function createTable(name, max = 10, guests = []){
  const table = document.createElement("div");
  table.className = "table";
  table.dataset.max = String(max);
  table.dataset.baseName = normalizeName(name) || "B√†n";

  table.innerHTML = `
    <div class="table-header">
      <h3 class="table-title"></h3>
      <div class="table-actions">
        <button class="quick-add-btn">‚ûï</button>
        <button class="edit-table-btn">‚úèÔ∏è</button>
        <button class="delete-table-btn">üóëÔ∏è</button>
      </div>
    </div>
    <div class="quick-add hidden">
      <input class="quick-add-input" placeholder="Nh·∫≠p t√™n kh√°ch..." />
      <div class="quick-add-hint">Enter ¬∑ Esc</div>
    </div>
    <ul class="guest-list"></ul>
    <div class="table-warning hidden"></div>
  `;

  const ul = table.querySelector(".guest-list");
  guests.forEach(g => ul.appendChild(createGuestLi(g)));

  tablesEl.appendChild(table);
  updateTable(table);
}

function updateTable(table){
  const list = table.querySelector(".guest-list");

  // ‚≠ê KH√îI PH·ª§C T√äN ƒê·∫¶Y ƒê·ª¶ CHO KH√ÅCH TRONG B√ÄN
  list.querySelectorAll("li:not(.drag-placeholder)").forEach(li => {
    li.textContent = li.dataset.name;
  });

  const count = list.querySelectorAll("li:not(.drag-placeholder)").length;
  const max = parseInt(table.dataset.max, 10);
  const name = normalizeName(table.dataset.baseName || "B√†n");
  table.querySelector(".table-title").textContent = `${name} (${count}/${max})`;

  const warning = table.querySelector(".table-warning");
  if(count > max){
    table.classList.add("over");
    warning.innerHTML = `‚ö†Ô∏è B√†n ƒë√£ d∆∞ ng∆∞·ªùi (${count-max})<br>
      <button class="auto-fix-btn">Auto ƒë∆∞a v·ªÅ Ch∆∞a s·∫Øp x·∫øp</button>`;
    warning.classList.remove("hidden");
  } else {
    table.classList.remove("over");
    warning.classList.add("hidden");
    warning.innerHTML = "";
  }

  updateSummary();
}


/* ================= Add ================= */
document.getElementById("add-table").onclick = () => {
  createTable(`B√†n ${document.querySelectorAll(".table").length + 1}`);
  saveState();
};
document.getElementById("add-guest").onclick = () => {
  guestInput.value.split("\n").map(normalizeName).filter(Boolean)
    .forEach(n => unassigned.appendChild(createGuestLi(n)));
  guestInput.value = "";
  saveState();
  updateUnassignedView();
};

/* ================= Drag & Drop desktop ================= */
let draggedItem = null;
const placeholder = document.createElement("li");
placeholder.className = "drag-placeholder";

function getDragAfterElement(container, y){
  const items = [...container.querySelectorAll("li:not(.dragging):not(.drag-placeholder)")];
  return items.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    if(offset < 0 && offset > closest.offset){
      return { offset, element: child };
    }
    return closest;
  }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
}

document.addEventListener("dragstart", e => {
  if(e.target.tagName !== "LI") return;
  draggedItem = e.target;
  draggedItem.classList.add("dragging");
  e.dataTransfer.setData("","");
});
document.addEventListener("dragover", e => {
  const list = e.target.closest(".guest-list");
  if(!list || !draggedItem) return;
  e.preventDefault();
  const after = getDragAfterElement(list, e.clientY);
  after ? list.insertBefore(placeholder, after) : list.appendChild(placeholder);
  updateDropHints();
});
document.addEventListener("drop", e => {
  const list = e.target.closest(".guest-list");
  if(!list || !draggedItem) return;
  e.preventDefault();
  list.insertBefore(draggedItem, placeholder);
  draggedItem.textContent = draggedItem.dataset.name;
  placeholder.remove();
  draggedItem.classList.remove("dragging");
  draggedItem = null;
  clearDropHints();
  document.querySelectorAll(".table").forEach(updateTable);
  saveState();
  updateUnassignedView();
});
document.addEventListener("dragend", () => {
  placeholder.remove();
  clearDropHints();
  updateUnassignedView();
});

/* ================= Touch drag ================= */
if(isTouch){
  let touchItem=null, touchClone=null, timer=null;

  document.addEventListener("touchstart", e=>{
    const li=e.target.closest(".guest-list li");
    if(!li) return;
    timer=setTimeout(()=>{
      touchItem=li;
      const r=li.getBoundingClientRect();
      touchClone=li.cloneNode(true);
      touchClone.classList.add("touch-dragging");
      touchClone.style.width=r.width+"px";
      document.body.appendChild(touchClone);
      placeholder.style.height=r.height+"px";
      li.parentElement.insertBefore(placeholder,li);
      li.style.visibility="hidden";
    },200);
  },{passive:false});

  document.addEventListener("touchmove", e=>{
    if(timer){clearTimeout(timer);timer=null;}
    if(!touchItem||!touchClone) return;
    e.preventDefault();
    const t=e.touches[0];
    touchClone.style.left=t.clientX-touchClone.offsetWidth/2+"px";
    touchClone.style.top=t.clientY-touchClone.offsetHeight/2+"px";
    const el=document.elementFromPoint(t.clientX,t.clientY);
    const list=el?.closest(".guest-list");
    if(!list) return;
    const after=getDragAfterElement(list,t.clientY);
    after?list.insertBefore(placeholder,after):list.appendChild(placeholder);
    updateDropHints();
    if(t.clientY<80) window.scrollBy(0,-10);
    if(window.innerHeight-t.clientY<80) window.scrollBy(0,10);
  },{passive:false});

  document.addEventListener("touchend", ()=>{
    if(!touchItem) return;
    placeholder.parentElement.insertBefore(touchItem,placeholder);
    touchItem.style.visibility="";
    placeholder.remove();
    touchClone.remove();
    touchItem=null;touchClone=null;
    clearDropHints();
    document.querySelectorAll(".table").forEach(updateTable);
    saveState();
    updateUnassignedView();
  });
}

/* ================= Touch drag (Android) ================= */
if(isTouch){
  // Tr√°nh xung ƒë·ªôt HTML5 drag tr√™n mobile
  document.addEventListener("touchstart", e => {
    const li = e.target.closest("li");
    if(li) li.draggable = false;
  }, {passive:true});

  let tDragged = null;
  let ghost = null;

  function ensurePlaceholder(list){
    if(!placeholder.parentElement) list.appendChild(placeholder);
  }

  function listFromPoint(x, y){
    const el = document.elementFromPoint(x, y);
    return el ? el.closest(".guest-list") : null;
  }

  document.addEventListener("touchstart", e => {
    const li = e.target.closest(".guest-list li");
    if(!li || li.classList.contains("drag-placeholder")) return;

    tDragged = li;

    const r = li.getBoundingClientRect();
    ghost = li.cloneNode(true);
    ghost.classList.add("touch-dragging");
    ghost.style.left = `${r.left}px`;
    ghost.style.top = `${r.top}px`;
    ghost.style.width = `${r.width}px`;
    document.body.appendChild(ghost);

    li.classList.add("dragging");

    const list = li.closest(".guest-list");
    ensurePlaceholder(list);
    list.insertBefore(placeholder, li.nextSibling);

    e.preventDefault();
  }, {passive:false});

  document.addEventListener("touchmove", e => {
    if(!tDragged || !ghost) return;

    const t = e.touches[0];
    ghost.style.left = `${t.clientX - ghost.offsetWidth / 2}px`;
    ghost.style.top  = `${t.clientY - 16}px`;

    const list = listFromPoint(t.clientX, t.clientY);
    if(!list) return;

    const after = getDragAfterElement(list, t.clientY);
    after ? list.insertBefore(placeholder, after) : list.appendChild(placeholder);

    updateDropHints();
    e.preventDefault();
  }, {passive:false});

  document.addEventListener("touchend", () => {
    if(!tDragged) return;

    const targetList = placeholder.closest(".guest-list");
    if(targetList){
      targetList.insertBefore(tDragged, placeholder);
      tDragged.textContent = tDragged.dataset.name;
    }

    placeholder.remove();
    clearDropHints();

    tDragged.classList.remove("dragging");
    tDragged = null;

    if(ghost){
      ghost.remove();
      ghost = null;
    }

    document.querySelectorAll(".table").forEach(updateTable);
    saveState();
    updateUnassignedView();
  }, {passive:true});

  document.addEventListener("touchcancel", () => {
    if(ghost) ghost.remove();
    ghost = null;

    if(tDragged){
      tDragged.classList.remove("dragging");
      tDragged.textContent = tDragged.dataset.name;
    }

    tDragged = null;

    placeholder.remove();
    clearDropHints();
    updateUnassignedView();
  }, {passive:true});

}

/* ================= Drop hints ================= */
function updateDropHints(){
  document.querySelectorAll(".table").forEach(t=>{
    const max=parseInt(t.dataset.max,10);
    const count=t.querySelectorAll("li:not(.drag-placeholder)").length;
    t.classList.toggle("can-drop",count<max);
    t.classList.toggle("cannot-drop",count>=max);
  });
}
function clearDropHints(){
  document.querySelectorAll(".table").forEach(t=>{
    t.classList.remove("can-drop","cannot-drop");
  });
}

/* ================= Table actions ================= */
function closeQuickAdd(box){
  box.querySelector("input").value="";
  box.classList.add("hidden");
  box.classList.remove("active");
}

tablesEl.addEventListener("click", e=>{
  const table=e.target.closest(".table");
  if(!table) return;

  if(e.target.classList.contains("quick-add-btn")){
    const box=table.querySelector(".quick-add");
    document.querySelectorAll(".quick-add.active").forEach(b=>b!==box&&closeQuickAdd(b));
    box.classList.remove("hidden");
    box.classList.add("active");
    box.querySelector("input").focus();
    return;
  }

  if(e.target.classList.contains("edit-table-btn")){
    const title = table.querySelector(".table-title");
    title.contentEditable = true;
    title.focus();
    title.scrollIntoView({behavior:"smooth",block:"center"});
    document.execCommand("selectAll");
    return;
  }

  if(e.target.classList.contains("delete-table-btn")){
    if(!confirm(`X√≥a ${table.dataset.baseName}?\nTo√†n b·ªô kh√°ch s·∫Ω chuy·ªÉn v·ªÅ "Ch∆∞a s·∫Øp x·∫øp".`)) return;
    table.querySelectorAll(".guest-list li:not(.drag-placeholder)")
      .forEach(li => unassigned.appendChild(li));
    table.remove();
    updateSummary();
    saveState();
    updateUnassignedView();
    return;
  }

  if(e.target.classList.contains("auto-fix-btn")){
    const max = parseInt(table.dataset.max, 10);
    const list = table.querySelector(".guest-list");
    const extra = list.querySelectorAll("li:not(.drag-placeholder)").length - max;
    if(!confirm(`ƒê∆∞a ${extra} kh√°ch d∆∞ v·ªÅ "Ch∆∞a s·∫Øp x·∫øp"?`)) return;
    [...list.querySelectorAll("li:not(.drag-placeholder)")].slice(max)
      .forEach(li => unassigned.appendChild(li));
    updateTable(table);
    saveState();
    updateUnassignedView();
    return;
  }
});

/* ================= Quick add / rename ================= */
tablesEl.addEventListener("keydown", e => {
  if(e.target.classList.contains("quick-add-input")){
    const table = e.target.closest(".table");
    const box = e.target.closest(".quick-add");
    const list = table.querySelector(".guest-list");
    const max = parseInt(table.dataset.max, 10);

    if(e.key === "Enter"){
      e.preventDefault();
      const name = normalizeName(e.target.value);
      if(!name) return;

      const count = list.querySelectorAll("li:not(.drag-placeholder)").length;
      if(count >= max){
        alert("B√†n ƒë√£ ƒë·ªß ng∆∞·ªùi!");
        return;
      }

      list.appendChild(createGuestLi(name));
      closeQuickAdd(box);
      updateTable(table);
      saveState();
      updateUnassignedView();
      return;
    }

    if(e.key === "Escape"){
      e.preventDefault();
      closeQuickAdd(box);
      return;
    }
  }

  if(e.target.classList.contains("table-title") && e.key === "Enter"){
    e.preventDefault();
    e.target.blur();
  }
});

tablesEl.addEventListener("blur", e => {
  if(!e.target.classList.contains("table-title")) return;
  const table = e.target.closest(".table");
  const raw = e.target.textContent.replace(/\s*\(\d+\/\d+\)\s*$/, "");
  table.dataset.baseName = normalizeName(raw) || "B√†n";
  e.target.contentEditable = false;
  updateTable(table);
  saveState();
}, true);

document.addEventListener("click", e => {
  document.querySelectorAll(".quick-add.active").forEach(box => {
    const inside = box.contains(e.target);
    const isBtn = e.target.closest(".quick-add-btn");
    if(!inside && !isBtn) closeQuickAdd(box);
  });
});

/* ================= Adjust max ================= */
document.getElementById("adjust-max").onclick = () => {
  maxList.innerHTML = "";
  document.querySelectorAll(".table").forEach((t,i) => {
    const row = document.createElement("div");
    row.className = "max-row";
    row.innerHTML = `<label>${t.dataset.baseName}</label>
      <input type="number" min="1" value="${t.dataset.max}" data-i="${i}">`;
    maxList.appendChild(row);
  });
  maxModal.style.display = "flex";
};

document.getElementById("max-save").onclick = () => {
  const bulk = parseInt(document.getElementById("bulk-max").value, 10);

  if(!isNaN(bulk) && bulk > 0){
    // √Åp d·ª•ng h√†ng lo·∫°t
    document.querySelectorAll(".table").forEach(t => {
      t.dataset.max = String(bulk);
      updateTable(t);
    });
  } else {
    // √Åp d·ª•ng t·ª´ng b√†n nh∆∞ c≈©
    document.querySelectorAll("#max-list input").forEach(inp => {
      const t = document.querySelectorAll(".table")[inp.dataset.i];
      t.dataset.max = String(Math.max(1, parseInt(inp.value, 10) || 1));
      updateTable(t);
    });
  }

  maxModal.style.display = "none";
  saveState();
};


document.getElementById("max-cancel").onclick = () => {
  maxModal.style.display = "none";
};

/* ================= Export dropdown ================= */
exportBtn.onclick = (e) => {
  e.stopPropagation();
  exportMenu.style.display = exportMenu.style.display === "flex" ? "none" : "flex";
};
document.addEventListener("click", () => exportMenu.style.display = "none");

/* ================= Print / PDF (Android-safe via iframe) ================= */
function sanitizeForPrint(root){
  root.querySelectorAll(".table-actions,.quick-add,.table-warning").forEach(el=>el.remove());
  root.querySelectorAll(".drag-placeholder").forEach(el=>el.remove());
  // g·ª° c√°c n√∫t x√≥a n·∫øu ƒëang ·ªü delete mode
  root.querySelectorAll(".delete-x").forEach(el=>el.remove());
  root.querySelectorAll(".marked-delete").forEach(li=>li.classList.remove("marked-delete"));
}

function printHTML(html){
  const iframe = document.createElement("iframe");
  iframe.style.position = "fixed";
  iframe.style.right = "0";
  iframe.style.bottom = "0";
  iframe.style.width = "0";
  iframe.style.height = "0";
  iframe.style.border = "0";
  document.body.appendChild(iframe);

  const doc = iframe.contentDocument || iframe.contentWindow.document;
  const cssText = document.querySelector("style") ? document.querySelector("style").innerHTML : "";

  doc.open();
  doc.write(`<!doctype html><html><head><meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Print</title>
    <style>${cssText}</style>
    <style>
      body{background:#fff}
      .layout{display:none!important}
      #print-root{display:block!important; position:static!important}
      @media print{
        @page{size:A4;margin:10mm}
      }
    </style>
  </head><body>
    <div id="print-root">${html}</div>
  </body></html>`);
  doc.close();

  // sanitize trong iframe
  sanitizeForPrint(doc.getElementById("print-root"));

  // Android c·∫ßn delay ƒë·ªÉ layout xong tr∆∞·ªõc khi print
  setTimeout(() => {
    iframe.contentWindow.focus();
    iframe.contentWindow.print();

    // d·ªçn iframe sau khi g·ªçi print
    setTimeout(() => iframe.remove(), 1000);
  }, 400);
}


/* ================= Export ================= */
document.getElementById("export-csv").onclick = () => {
  let csv = "B√†n,T√™n kh√°ch\n";
  document.querySelectorAll(".table").forEach(t => {
    t.querySelectorAll(".guest-list li:not(.drag-placeholder)").forEach(li => {
      csv += `"${t.dataset.baseName}","${guestNameFromLi(li)}"\n`;
    });
  });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([csv], {type:"text/csv"}));
  a.download = "ban-tiec.csv";
  a.click();
};

document.getElementById("export-pdf-all").onclick = () => {
  const wrapper = document.createElement("div");

  const unassignedBlock = document.createElement("div");
unassignedBlock.style.pageBreakAfter = "always";   // üëà D√íNG QUAN TR·ªåNG
unassignedBlock.innerHTML = `
  <h2>Ch∆∞a s·∫Øp x·∫øp</h2>
  <ul class="guest-list">
    ${[...unassigned.querySelectorAll("li:not(.drag-placeholder)")]
      .map(li => `<li>${guestNameFromLi(li)}</li>`).join("")}
  </ul>
`;
wrapper.appendChild(unassignedBlock);


  document.querySelectorAll(".table").forEach(t => wrapper.appendChild(t.cloneNode(true)));
  printHTML(wrapper.innerHTML);
};

document.getElementById("export-pdf-one").onclick = () => {
  pdfTableSelect.innerHTML = "";
  document.querySelectorAll(".table").forEach((t,i) => {
    const o = document.createElement("option");
    o.value = i;
    o.textContent = t.dataset.baseName;
    pdfTableSelect.appendChild(o);
  });
  pdfOneModal.style.display = "flex";
};

document.getElementById("pdf-one-export").onclick = () => {
  const t = document.querySelectorAll(".table")[pdfTableSelect.value];
  pdfOneModal.style.display = "none";
  printHTML(t.outerHTML);
};
document.getElementById("pdf-one-cancel").onclick = () => pdfOneModal.style.display = "none";

/* ================= Save / Load ================= */
document.getElementById("save-btn").onclick = () => {
  saveState();
  alert("ƒê√£ l∆∞u!");
};

document.getElementById("clear-btn").onclick = () => {
  if(confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu?")){
    localStorage.removeItem("wedding_state");
    location.reload();
  }
};

function saveState(){
  const state = {
    tables: [...document.querySelectorAll(".table")].map(t => ({
      name: t.dataset.baseName,
      max: t.dataset.max,
      guests: [...t.querySelectorAll(".guest-list li:not(.drag-placeholder)")]
        .map(li => guestNameFromLi(li))
    })),
    unassigned: [...unassigned.querySelectorAll("li:not(.drag-placeholder)")]
      .map(li => guestNameFromLi(li))
  };
  localStorage.setItem("wedding_state", JSON.stringify(state));
}

(function load(){
  const raw = localStorage.getItem("wedding_state");
  if(!raw){
    createTable("B√†n 1");
    updateSummary();
    return;
  }
  const s = JSON.parse(raw);
  s.tables.forEach(t => createTable(t.name, t.max, t.guests));
  s.unassigned.forEach(n => unassigned.appendChild(createGuestLi(n)));
  document.querySelectorAll(".table").forEach(updateTable);
  updateUnassignedView();
})();

let deleteMode = false;

const deleteBtn = document.getElementById("delete-mode-btn");
const deleteConfirmBtn = document.getElementById("delete-confirm-btn");
const deleteCancelBtn = document.getElementById("delete-cancel-btn");

deleteBtn.onclick = () => {
  deleteMode = true;
  document.body.classList.add("delete-mode");

  deleteBtn.classList.add("hidden");
  deleteConfirmBtn.classList.remove("hidden");
  deleteCancelBtn.classList.remove("hidden");

  document.querySelectorAll(".guest-list li:not(.drag-placeholder)").forEach(li => {
    if(!li.querySelector(".delete-x")){
      const x = document.createElement("span");
      x.textContent = "‚úñ";
      x.className = "delete-x";
      li.appendChild(x);
    }
    li.classList.remove("marked-delete");
  });
};

deleteCancelBtn.onclick = () => {
  deleteMode = false;
  document.body.classList.remove("delete-mode");

  deleteBtn.classList.remove("hidden");
  deleteConfirmBtn.classList.add("hidden");
  deleteCancelBtn.classList.add("hidden");

  document.querySelectorAll(".delete-x").forEach(x => x.remove());
  document.querySelectorAll(".marked-delete").forEach(li => li.classList.remove("marked-delete"));
};

deleteConfirmBtn.onclick = () => {
  if(!confirm("X√≥a c√°c kh√°ch m·ªùi ƒë√£ ch·ªçn?")) return;

  document.querySelectorAll(".marked-delete").forEach(li => li.remove());

  deleteCancelBtn.onclick(); // reset mode
  document.querySelectorAll(".table").forEach(updateTable);
  saveState();
  updateUnassignedView();
};

/* Click ‚úñ ƒë·ªÉ ƒë√°nh d·∫•u */
document.addEventListener("click", e => {
  if(!deleteMode) return;
  if(e.target.classList.contains("delete-x")){
    e.target.closest("li").classList.toggle("marked-delete");
  }


});

document.getElementById("import-btn").onclick = () => {
  document.getElementById("import-csv").click();
};

document.getElementById("import-csv").addEventListener("change", e => {
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = () => parseCSV(reader.result);
  reader.readAsText(file, "utf-8");

  e.target.value = ""; // reset input
});

function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  if(lines.length < 2) return alert("CSV kh√¥ng h·ª£p l·ªá");

  const headers = lines[0].split(",").map(h => h.trim().toLowerCase());
  const idxName = headers.indexOf("t√™n kh√°ch");
  const idxTable = headers.indexOf("b√†n");

  if(idxName === -1) return alert("CSV ph·∫£i c√≥ c·ªôt 'T√™n kh√°ch'");

  lines.slice(1).forEach(line => {
    const cols = line.split(",").map(c => stripQuotes(c));
    const name = normalizeName(cols[idxName]);
    if(!name) return;

    if(idxTable !== -1 && cols[idxTable]){
      const tableName = normalizeName(stripQuotes(cols[idxTable]));
      let table = [...document.querySelectorAll(".table")]
        .find(t => t.dataset.baseName === tableName);

      if(!table){
        createTable(tableName);
        table = [...document.querySelectorAll(".table")]
          .find(t => t.dataset.baseName === tableName);
      }

      table.querySelector(".guest-list").appendChild(createGuestLi(name));
      updateTable(table);
    } else {
      unassigned.appendChild(createGuestLi(name));
    }
  });

  saveState();
  updateSummary();
  updateUnassignedView();

}

/* ================= Help modal ================= */
const helpModal = document.getElementById("help-modal");
document.getElementById("help-btn").onclick = () => {
  helpModal.style.display = "flex";
};
document.getElementById("help-close").onclick = () => {
  helpModal.style.display = "none";
};

/* ================= Edit Guest Names Mode ================= */

let originalNames = new Map();

const editBtn = document.getElementById("edit-names-btn");
const editSave = document.getElementById("edit-names-save");
const editCancel = document.getElementById("edit-names-cancel");

editBtn.onclick = () => {
  editNamesMode = true;
  document.body.classList.add("edit-names-mode");

  // Kh√≥a toolbar
  document.getElementById("toolbar-blocker").style.display = "block";


  // Ch·ªâ 3 n√∫t s·ª≠a t√™n ho·∫°t ƒë·ªông
  editBtn.classList.add("hidden");
  editSave.classList.remove("hidden");
  editCancel.classList.remove("hidden");

  // L∆∞u t√™n g·ªëc
  originalNames.clear();
  document.querySelectorAll(".guest-list li").forEach(li => {
    originalNames.set(li, li.dataset.name);
    li.contentEditable = "true";
    li.draggable = false;
  });

  // T·∫Øt k√©o th·∫£
  document.querySelectorAll(".guest-list li").forEach(li => li.draggable = false);

  // ‚≠ê C·∫¨P NH·∫¨T L·∫†I "CH∆ØA S·∫ÆP X·∫æP" THEO CH·∫æ ƒê·ªò S·ª¨A T√äN
  updateUnassignedView();
};

  
editCancel.onclick = () => {
  editNamesMode = false;
  document.body.classList.remove("edit-names-mode");

  // M·ªü l·∫°i toolbar
  document.getElementById("toolbar-blocker").style.display = "none";

  // Kh√¥i ph·ª•c t√™n c≈©
  originalNames.forEach((oldName, li) => {
    li.dataset.name = oldName;
    li.textContent = oldName;
    li.contentEditable = "false";
    li.draggable = true;
  });

  editBtn.classList.remove("hidden");
  editSave.classList.add("hidden");
  editCancel.classList.add("hidden");

  document.querySelectorAll(".guest-list li").forEach(li => li.draggable = true);

  updateSummary();

  // ‚≠ê QUAN TR·ªåNG: r√∫t g·ªçn l·∫°i t√™n ·ªü Ch∆∞a s·∫Øp x·∫øp
  updateUnassignedView();
};


editSave.onclick = () => {
  editNamesMode = false;
  document.body.classList.remove("edit-names-mode");

  // M·ªü l·∫°i toolbar
  document.getElementById("toolbar-blocker").style.display = "none";

  // L∆∞u t√™n m·ªõi
  document.querySelectorAll(".guest-list li").forEach(li => {
    const newName = normalizeName(li.textContent.trim());
    li.dataset.name = newName;
    li.textContent = newName;
    li.contentEditable = "false";
    li.draggable = true;
  });

  editBtn.classList.remove("hidden");
  editSave.classList.add("hidden");
  editCancel.classList.add("hidden");

  document.querySelectorAll(".table").forEach(updateTable);
  saveState();
};

</script>
<script type="text/javascript" src="js/script.js"></script>
</body>
</html>
