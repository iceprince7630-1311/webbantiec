<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>S·∫Øp x·∫øp b√†n ti·ªác</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      background:#f4f6fb;
      color:#111
    }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns:4fr 1.2fr;
      height:100vh;
      gap:12px;
      padding:12px
    }

    /* Toolbar */
    .toolbar{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap
    }
    .btn{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-weight:bold
    }
    .btn:hover{background:#eee}
    #add-table{
      font-size:22px;
      background:#111;
      color:#fff;
      border:none
    }
    #clear-btn{
      border-color:#dc2626;
      color:#dc2626
    }
    #clear-btn:hover{
      background:#dc2626;
      color:#fff
    }

    /* Summary */
    #summary{
      margin-left:auto;
      font-weight:bold
    }

    /* Export */
    .export-menu{position:relative}
    .export-dropdown{
      position:absolute;
      top:110%;
      left:0;
      background:#fff;
      border:1px solid #ccc;
      border-radius:10px;
      padding:6px;
      display:none;
      flex-direction:column;
      gap:4px;
      z-index:10;
      min-width:200px
    }
    .export-dropdown button{text-align:left}

    /* Tables */
    .tables{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
      gap:12px;
      overflow:auto;
      margin-top:10px
    }
    .table{
      background:#fff;
      border-radius:12px;
      padding:10px;
      border:1px solid #ddd;
      display:flex;
      flex-direction:column
    }
    .table.over{
      background:#fee2e2;
      border:2px solid #dc2626
    }

    /* Color accents */
    .table:nth-child(4n+1){border-top:4px solid #2563eb}
    .table:nth-child(4n+2){border-top:4px solid #16a34a}
    .table:nth-child(4n+3){border-top:4px solid #f59e0b}
    .table:nth-child(4n+4){border-top:4px solid #dc2626}

    .table-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      padding-bottom:6px;
      border-bottom:1px solid #eee
    }
    .table-title{
      margin:0;
      font-size:15px;
      outline:none
    }
    .table-actions{display:flex;gap:4px}
    .table-actions button{
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer
    }

    /* Guest list */
    .guest-list{
      list-style:none;
      padding:6px;
      margin:8px 0;
      border:2px dashed #ccc;
      min-height:80px;
      border-radius:8px;
      counter-reset:guest;
    }
    .guest-list li{
      background:#fff;
      border:1px solid #ccc;
      border-radius:6px;
      padding:6px;
      margin-bottom:4px;
      cursor:grab;
      position:relative;
      user-select:none;
    }
    .guest-list li:not(.drag-placeholder)::before{
      counter-increment:guest;
      content: counter(guest) ".";
      display:inline-block;
      min-width:28px;
      margin-right:6px;
      color:#555;
      font-weight:bold;
    }

    /* Drag UI */
    .drag-placeholder{
      height:32px;
      margin-bottom:4px;
      border:2px dashed #2563eb;
      border-radius:6px;
      background:rgba(37,99,235,.08);
    }
    .dragging{opacity:.4}

    /* Touch drag */
    @media (pointer: coarse){
      .guest-list li{touch-action:none}
    }
    .touch-dragging{
      position:fixed;
      z-index:10000;
      pointer-events:none;
      opacity:.85;
      transform:scale(1.05);
      box-shadow:0 8px 20px rgba(0,0,0,.25);
      background:#fef3c7;
    }

    /* Drop hints */
    .table.can-drop{outline:3px solid #16a34a}
    .table.cannot-drop{outline:3px solid #dc2626}

    /* Warning */
    .table-warning{
      margin-top:6px;
      padding:8px;
      border-radius:8px;
      background:#fee2e2;
      color:#991b1b;
      font-size:13px
    }

    /* Sidebar layout */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: 100%;
      overflow: hidden;
    }

    /* Ch∆∞a s·∫Øp x·∫øp (b·∫£n c≈© c√≥ wrapper, ta d√πng card m·ªõi b√™n d∆∞·ªõi) */
    #unassigned-wrapper {
      flex: 1;
      overflow-y: auto;
      padding-right: 6px;
      background: #fff;
      border-radius: 12px;
      border: 1px solid #ddd;
      display: flex;
      flex-direction: column;
    }

    #unassigned-wrapper-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      border-bottom: 1px solid #eee;
      background: #fafafa;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    #unassigned {
      padding: 10px;
      margin: 0;
      flex: 1;
    }

    /* Quick-add c≈© (s·∫Ω override b√™n d∆∞·ªõi) */
    .quick-add {
      position: sticky;
      bottom: 0;
      background: #fff;
      z-index: 1999;
      border-top: 1px solid #ddd;
      padding-top: 14px;
      padding-bottom: 14px;
    }

    textarea{
      width:100%;
      height:120px;
      border-radius:8px;
      padding:8px
    }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.4);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:100
    }
    .modal-content{
      background:#fff;
      padding:16px;
      border-radius:14px;
      width:360px;
      max-width:90vw
    }
    .modal-actions{
      display:flex;
      justify-content:flex-end;
      gap:8px;
      margin-top:14px
    }

    /* Print */
    @media print{
      .layout{display:none!important}
      #print-root{display:block!important}
      .table-actions,.quick-add,.table-warning{display:none!important}
      .table{page-break-inside:avoid}
      .table + .table{page-break-before:always}
      .table-title{font-size:18px}
      @page{size:A4;margin:10mm}
    }
    #print-root{
      position:fixed;
      inset:0;
      background:#fff;
      z-index:9999;
      display:none;
      overflow:auto;
      padding:12px
    }

    /* Mobile spacing */
    @media (max-width:768px){
      .btn{padding:10px 14px}
      #add-table{font-size:26px}
      .table{padding:12px}
    }

    .delete-x{
      position:absolute;
      right:6px;
      top:4px;
      font-size:12px;
      cursor:pointer;
      color:#dc2626;
      display:none;
    }
    .delete-mode li .delete-x{display:block}
    .marked-delete{opacity:.4;text-decoration:line-through}

    .edit-names-mode li {
      cursor: text !important;
      background: #fff7d6;
    }
    .edit-names-mode .guest-list li.dragging {
      opacity: 1 !important;
    }

    #toolbar-blocker {
      position: absolute;
      top: 0;
      left: 0;
      width: 76.67%;
      height: 55px;
      background: rgba(255,255,255,0.5);
      backdrop-filter: blur(2px);
      z-index: 900;
      display: none;
      pointer-events: auto;
      border-radius: 0px 0px 10px 10px;
    }

    .edit-only {
      position: relative;
      z-index: 1001;
    }

    /* ============================
       SIDEBAR FIX & OPTIMIZATION
       ============================ */

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: 100%;
      overflow: hidden;
    }

    #unassigned-wrapper {
      flex: 1;
      overflow-y: auto;
      padding-right: 6px;
      border-radius: 12px;
    }

    #unassigned-wrapper-header {
      position: sticky;
      top: 0;
      background: #fff;
      padding: 10px;
      border-bottom: 1px solid #eee;
      z-index: 5;
    }

    /* Quick-add m·ªõi: card tr√™n c√πng sidebar */
    .quick-add {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 8px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .quick-add textarea {
      height: 90px;
      max-height: 140px;
      resize: vertical;
    }

    .hidden {
      display: none !important;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 100vh;
    }

    /* Card "Ch∆∞a s·∫Øp x·∫øp" chi·∫øm ph·∫ßn c√≤n l·∫°i */
    .unassigned-card {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
    }

    .unassigned-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      padding-bottom: 6px;
      border-bottom: 1px solid #eee;
    }

    .unassigned-scroll {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding-right: 4px;
    }

    #help-modal {
      z-index: 2000 !important;
    }

    /* Kh√°ch ƒëang ƒë∆∞·ª£c ch·ªçn tr√™n Android */
    .selected-guest {
      background: #ffe0b2 !important;
      border: 2px solid #ff9800 !important;
    }
  </style>
</head>
<body>
  <div class="layout">
    <div>
      <div class="toolbar">
        <button id="add-table">+</button>
        <button id="adjust-max" class="btn">‚öôÔ∏è Ch·ªânh max</button>

        <button id="edit-names-btn" class="btn edit-only">‚úèÔ∏è S·ª≠a t√™n kh√°ch</button>
        <button id="edit-names-save" class="btn hidden edit-only">üíæ ƒê·ªìng √Ω</button>
        <button id="edit-names-cancel" class="btn hidden edit-only">‚ùå H·ªßy</button>

        <button id="save-btn" class="btn">üíæ L∆∞u</button>
        <button id="clear-btn" class="btn">üßπ X√≥a</button>
        <input type="file" id="import-csv" accept=".csv" hidden>
        <button id="import-btn" class="btn">üì• Import CSV</button>

        <div class="export-menu">
          <button id="export-btn" class="btn">üì§ Xu·∫•t</button>
          <div id="export-menu" class="export-dropdown">
            <button id="export-csv">üìä Excel (CSV)</button>
            <button id="export-pdf-all">üñ®Ô∏è PDF t·∫•t c·∫£</button>
            <button id="export-pdf-one">üßæ PDF 1 b√†n</button>
          </div>
        </div>

        <button id="help-btn" class="btn">‚ùì H∆∞·ªõng d·∫´n</button>

        <div id="summary">
          T·ªïng: <span id="total-guests">0</span> kh√°ch ¬∑
          <span id="total-tables">0</span> b√†n
        </div>
      </div>

      <div id="toolbar-blocker"></div>

      <div class="tables" id="tables"></div>
    </div>

    <!-- SIDEBAR -->
    <div class="sidebar">

      <!-- TH√äM KH√ÅCH LU√îN TR√äN C√ôNG -->
      <div class="card quick-add">
        <h3>Th√™m kh√°ch</h3>
        <textarea id="guest-input" placeholder="M·ªói d√≤ng l√† 1 t√™n..."></textarea>
        <button id="add-guest" class="btn">Th√™m</button>
      </div>

      <!-- CH∆ØA S·∫ÆP X·∫æP -->
      <div class="card unassigned-card">
        <div class="unassigned-header">
          <h3>Ch∆∞a s·∫Øp x·∫øp</h3>
          <div>
            <button id="delete-mode-btn" class="btn">üóëÔ∏è</button>
            <button id="delete-confirm-btn" class="btn hidden">‚úÖ</button>
            <button id="delete-cancel-btn" class="btn hidden">‚ùå</button>
          </div>
        </div>

        <div class="unassigned-scroll">
          <ul class="guest-list" id="unassigned"></ul>
        </div>
      </div>

    </div>
  </div>

  <!-- MODALS -->
  <div class="modal" id="max-modal">
    <div class="modal-content">
      <h3>Ch·ªânh s·ªë kh√°ch t·ªëi ƒëa</h3>
      <div style="margin-bottom:10px">
        <label><b>Ch·ªânh h√†ng lo·∫°t:</b></label>
        <input type="number" id="bulk-max" min="1" placeholder="Nh·∫≠p s·ªë kh√°ch t·ªëi ƒëa..." 
          style="width:100%;padding:6px;border-radius:6px;border:1px solid #ccc;margin-top:4px">
        <div style="font-size:12px;color:#666;margin-top:2px">
          Khi nh·∫≠p s·ªë v√†o ƒë√¢y, t·∫•t c·∫£ b√†n s·∫Ω c√≥ s·ªë kh√°ch t·ªëi ƒëa gi·ªëng nhau.
        </div>
      </div>

      <div id="max-list"></div>
      <div class="modal-actions">
        <button id="max-cancel" class="btn">H·ªßy</button>
        <button id="max-save" class="btn">L∆∞u</button>
      </div>
    </div>
  </div>

  <div class="modal" id="pdf-one-modal">
    <div class="modal-content">
      <h3>Xu·∫•t PDF 1 b√†n</h3>
      <select id="pdf-table-select" style="width:100%;padding:8px;border-radius:8px"></select>
      <div class="modal-actions">
        <button id="pdf-one-cancel" class="btn">H·ªßy</button>
        <button id="pdf-one-export" class="btn">Xu·∫•t</button>
      </div>
    </div>
  </div>

  <div class="modal" id="help-modal">
    <div class="modal-content">
      <h3>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>
      <div id="help-content" style="max-height:60vh;overflow:auto;line-height:1.5">
        <h4>1. T·∫°o b√†n</h4>
        <p>B·∫•m n√∫t <b>+</b> ƒë·ªÉ t·∫°o th√™m b√†n m·ªõi. M·ªói b√†n c√≥ t√™n v√† s·ªë kh√°ch t·ªëi ƒëa.</p>

        <h4>2. Ch·ªânh s·ªë kh√°ch t·ªëi ƒëa</h4>
        <p>B·∫•m <b>‚öôÔ∏è Ch·ªânh max</b> ƒë·ªÉ thay ƒë·ªïi s·ªë kh√°ch t·ªëi ƒëa c·ªßa t·ª´ng b√†n.</p>

        <h4>3. L∆∞u d·ªØ li·ªáu</h4>
        <p>B·∫•m <b>üíæ L∆∞u</b> ƒë·ªÉ l∆∞u to√†n b·ªô b·ªë c·ª•c v√†o tr√¨nh duy·ªát.</p>

        <h4>4. Xu·∫•t d·ªØ li·ªáu</h4>
        <p>D√πng menu <b>üì§ Xu·∫•t</b> ƒë·ªÉ xu·∫•t CSV, PDF t·∫•t c·∫£ ho·∫∑c PDF t·ª´ng b√†n.</p>

        <h4>5. Import CSV</h4>
        <p>B·∫•m <b>üì• Import CSV</b> ƒë·ªÉ nh·∫≠p danh s√°ch kh√°ch t·ª´ file CSV.</p>

        <h4>6. Th√™m kh√°ch v√†o b√†n</h4>
        <p>B·∫•m n√∫t <b>‚ûï</b> tr√™n m·ªói b√†n ƒë·ªÉ th√™m kh√°ch nhanh.</p>

        <h4>7. Th√™m kh√°ch nhanh</h4>
        <p>Nh·∫≠p nhi·ªÅu t√™n v√†o √¥ ‚ÄúTh√™m kh√°ch‚Äù (m·ªói d√≤ng 1 t√™n) r·ªìi b·∫•m <b>Th√™m</b>.</p>

        <h4>8. K√©o‚Äëth·∫£ kh√°ch</h4>
        <p>K√©o kh√°ch gi·ªØa c√°c b√†n ho·∫∑c t·ª´ ‚ÄúCh∆∞a s·∫Øp x·∫øp‚Äù ƒë·ªÉ b·ªë tr√≠ ch·ªó ng·ªìi.</p>
      </div>
      <div class="modal-actions">
        <button id="help-close" class="btn">Tr·ªü v·ªÅ</button>
      </div>
    </div>
  </div>

  <div id="print-root"></div>

 <script>

/* =======================
   B∆Ø·ªöC 1 ‚Äî KH·ªûI T·∫†O BI·∫æN
   ======================= */

const tablesEl = document.getElementById("tables");
const unassigned = document.getElementById("unassigned");
const guestInput = document.getElementById("guest-input");
const exportBtn = document.getElementById("export-btn");
const exportMenu = document.getElementById("export-menu");
const printRoot = document.getElementById("print-root");

const maxModal = document.getElementById("max-modal");
const maxList = document.getElementById("max-list");

const pdfOneModal = document.getElementById("pdf-one-modal");
const pdfTableSelect = document.getElementById("pdf-table-select");

/* Nh·∫≠n di·ªán thi·∫øt b·ªã */
const isTouch = ("ontouchstart" in window) || (navigator.maxTouchPoints > 0);
const isAndroid = /Android/i.test(navigator.userAgent || "");

/* Tr·∫°ng th√°i */
let editNamesMode = false;
let deleteMode = false;
let selectedGuest = null;

/* =======================
   B∆Ø·ªöC 1 ‚Äî H√ÄM HELPER
   ======================= */

function normalizeName(s){
  return String(s||"").trim().replace(/\s+/g," ");
}

function stripQuotes(s){
  return String(s || "").replace(/^"(.*)"$/, "$1").trim();
}

function guestNameFromLi(li){
  return li.dataset.name || normalizeName(li.textContent);
}

/* T·∫°o 1 kh√°ch <li> ‚Äî ƒë√£ fix Android */
function createGuestLi(name){
  const clean = normalizeName(name);
  const li = document.createElement("li");
  li.dataset.name = clean;
  li.textContent = clean;

  /* Windows: drag = true
     Android: drag = false */
  li.draggable = !isAndroid;

  return li;
}

/* R√∫t g·ªçn t√™n (d√πng cho danh s√°ch d√†i) */
function shortName(full){
  const parts = full.trim().split(/\s+/);
  if(parts.length <= 2) return full;
  return parts.slice(-2).join(" ");
}

/* B·ªè ch·ªçn kh√°ch ƒëang ch·ªçn (Android) */
function clearSelectedGuest(){
  if(selectedGuest){
    selectedGuest.classList.remove("selected-guest");
    selectedGuest = null;
  }
}
/* =======================
   B∆Ø·ªöC 2 ‚Äî T·∫†O B√ÄN & UPDATE
   ======================= */

/* T·∫°o 1 b√†n m·ªõi */
function createTable(name, max = 10, guests = []) {
  const table = document.createElement("div");
  table.className = "table";
  table.dataset.max = String(max);
  table.dataset.baseName = normalizeName(name) || "B√†n";

  table.innerHTML = `
    <div class="table-header">
      <h3 class="table-title"></h3>
      <div class="table-actions">
        <button class="quick-add-btn">‚ûï</button>
        <button class="edit-table-btn">‚úèÔ∏è</button>
        <button class="delete-table-btn">üóëÔ∏è</button>
      </div>
    </div>

    <div class="quick-add hidden">
      <input class="quick-add-input" placeholder="Nh·∫≠p t√™n kh√°ch..." />
      <div class="quick-add-hint">Enter ¬∑ Esc</div>
    </div>

    <ul class="guest-list"></ul>
    <div class="table-warning hidden"></div>
  `;

  const ul = table.querySelector(".guest-list");
  guests.forEach(g => ul.appendChild(createGuestLi(g)));

  tablesEl.appendChild(table);
  updateTable(table);
}

/* C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng kh√°ch + c·∫£nh b√°o + ti√™u ƒë·ªÅ */
function updateTable(table) {
  const list = table.querySelector(".guest-list");

  // Lu√¥n hi·ªÉn th·ªã t√™n ƒë·∫ßy ƒë·ªß trong b√†n
  list.querySelectorAll("li:not(.drag-placeholder)").forEach(li => {
    li.textContent = li.dataset.name;
  });

  const count = list.querySelectorAll("li:not(.drag-placeholder)").length;
  const max = parseInt(table.dataset.max, 10);
  const name = normalizeName(table.dataset.baseName || "B√†n");

  table.querySelector(".table-title").textContent = `${name} (${count}/${max})`;

  const warning = table.querySelector(".table-warning");

  if (count > max) {
    table.classList.add("over");
    warning.innerHTML = `‚ö†Ô∏è B√†n ƒë√£ d∆∞ ng∆∞·ªùi (${count - max})<br>
      <button class="auto-fix-btn">Auto ƒë∆∞a v·ªÅ Ch∆∞a s·∫Øp x·∫øp</button>`;
    warning.classList.remove("hidden");
  } else {
    table.classList.remove("over");
    warning.classList.add("hidden");
    warning.innerHTML = "";
  }

  updateSummary();
}

/* C·∫≠p nh·∫≠t t·ªïng s·ªë b√†n + t·ªïng s·ªë kh√°ch */
function updateSummary() {
  document.getElementById("total-tables").textContent =
    document.querySelectorAll(".table").length;

  document.getElementById("total-guests").textContent =
    document.querySelectorAll(".guest-list li:not(.drag-placeholder)").length;
}
/* =======================
   B∆Ø·ªöC 3 ‚Äî TH√äM KH√ÅCH & UPDATE UNASSIGNED
   ======================= */

/* Th√™m kh√°ch t·ª´ √¥ textarea */
document.getElementById("add-guest").onclick = () => {
  guestInput.value
    .split("\n")
    .map(normalizeName)
    .filter(Boolean)
    .forEach(n => unassigned.appendChild(createGuestLi(n)));

  guestInput.value = "";
  saveState();
  updateUnassignedView();
};

/* R√∫t g·ªçn danh s√°ch "Ch∆∞a s·∫Øp x·∫øp" khi qu√° d√†i */
function updateUnassignedView() {
  const list = document.getElementById("unassigned");
  const items = [...list.querySelectorAll("li:not(.drag-placeholder)")];
  const count = items.length;

  /* N·∫øu ƒëang s·ª≠a t√™n ‚Üí lu√¥n hi·ªÉn th·ªã ƒë·∫ßy ƒë·ªß */
  if (editNamesMode) {
    items.forEach(li => li.textContent = li.dataset.name);

    if (count < 20) {
      list.style.display = "block";
      list.style.gridTemplateColumns = "";
      list.style.maxHeight = "";
      list.style.overflowY = "";
    } else {
      list.style.display = "grid";
      list.style.gridTemplateColumns = "repeat(2, 1fr)";
      list.style.columnGap = "10px";
      list.style.maxHeight = "";
      list.style.overflowY = "";
    }
    return;
  }

  /* Reset v·ªÅ t√™n ƒë·∫ßy ƒë·ªß tr∆∞·ªõc */
  items.forEach(li => li.textContent = li.dataset.name);

  /* N·∫øu √≠t kh√°ch ‚Üí kh√¥ng r√∫t g·ªçn */
  if (count < 20) {
    list.style.display = "block";
    list.style.gridTemplateColumns = "";
    list.style.maxHeight = "";
    list.style.overflowY = "";
    return;
  }

  /* R√∫t g·ªçn t√™n */
  items.forEach(li => {
    li.textContent = shortName(li.dataset.name);
  });

  /* Lu√¥n hi·ªÉn th·ªã d·∫°ng 2 c·ªôt khi d√†i */
  list.style.display = "grid";
  list.style.gridTemplateColumns = "repeat(2, 1fr)";
  list.style.columnGap = "10px";

  /* N·∫øu qu√° d√†i ‚Üí cho scroll */
  if (count > 40) {
    list.style.maxHeight = "600px";
    list.style.overflowY = "auto";
  } else {
    list.style.maxHeight = "";
    list.style.overflowY = "";
  }
}
/* =======================
   B∆Ø·ªöC 4 ‚Äî DRAG & DROP (WINDOWS)
   ======================= */

let draggedItem = null;

/* Placeholder hi·ªÉn th·ªã v·ªã tr√≠ th·∫£ */
const placeholder = document.createElement("li");
placeholder.className = "drag-placeholder";

/* T√¨m v·ªã tr√≠ th·∫£ trong danh s√°ch */
function getDragAfterElement(container, y) {
  const items = [...container.querySelectorAll("li:not(.dragging):not(.drag-placeholder)")];

  return items.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;

    if (offset < 0 && offset > closest.offset) {
      return { offset, element: child };
    }
    return closest;
  }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
}

/* Ch·ªâ b·∫≠t drag‚Äëdrop tr√™n Windows */
if (!isAndroid) {

  /* B·∫Øt ƒë·∫ßu k√©o */
  document.addEventListener("dragstart", e => {
    if (e.target.tagName !== "LI") return;

    draggedItem = e.target;
    draggedItem.classList.add("dragging");

    /* B·∫Øt bu·ªôc cho Firefox */
    e.dataTransfer.setData("", "");
  });

  /* Khi k√©o qua danh s√°ch */
  document.addEventListener("dragover", e => {
    const list = e.target.closest(".guest-list");
    if (!list || !draggedItem) return;

    e.preventDefault();

    const after = getDragAfterElement(list, e.clientY);
    after ? list.insertBefore(placeholder, after) : list.appendChild(placeholder);

    updateDropHints();
  });

  /* Th·∫£ v√†o danh s√°ch */
  document.addEventListener("drop", e => {
    const list = e.target.closest(".guest-list");
    if (!list || !draggedItem) return;

    e.preventDefault();

    list.insertBefore(draggedItem, placeholder);
    draggedItem.textContent = draggedItem.dataset.name;

    placeholder.remove();
    draggedItem.classList.remove("dragging");
    draggedItem = null;

    clearDropHints();
    document.querySelectorAll(".table").forEach(updateTable);
    saveState();
    updateUnassignedView();
  });

  /* K√©o k·∫øt th√∫c */
  document.addEventListener("dragend", () => {
    placeholder.remove();
    clearDropHints();
    updateUnassignedView();
  });
}
/* =======================
   B∆Ø·ªöC 5 ‚Äî TOUCH‚ÄëDRAG (WINDOWS TOUCH ONLY)
   ======================= */

/* Ch·ªâ ch·∫°y tr√™n thi·∫øt b·ªã c·∫£m ·ª©ng KH√îNG ph·∫£i Android */
if (isTouch && !isAndroid) {

  let touchItem = null;
  let touchClone = null;
  let timer = null;

  /* B·∫Øt ƒë·∫ßu ch·∫°m gi·ªØ ƒë·ªÉ k√©o */
  document.addEventListener("touchstart", e => {
    const li = e.target.closest(".guest-list li");
    if (!li) return;

    /* Nh·∫•n gi·ªØ 200ms m·ªõi k√≠ch ho·∫°t k√©o */
    timer = setTimeout(() => {
      touchItem = li;

      const r = li.getBoundingClientRect();
      touchClone = li.cloneNode(true);
      touchClone.classList.add("touch-dragging");
      touchClone.style.width = r.width + "px";

      document.body.appendChild(touchClone);

      placeholder.style.height = r.height + "px";
      li.parentElement.insertBefore(placeholder, li);
      li.style.visibility = "hidden";
    }, 200);
  }, { passive: false });

  /* Di chuy·ªÉn */
  document.addEventListener("touchmove", e => {
    if (timer) {
      clearTimeout(timer);
      timer = null;
    }
    if (!touchItem || !touchClone) return;

    e.preventDefault();
    const t = e.touches[0];

    touchClone.style.left = t.clientX - touchClone.offsetWidth / 2 + "px";
    touchClone.style.top = t.clientY - touchClone.offsetHeight / 2 + "px";

    const el = document.elementFromPoint(t.clientX, t.clientY);
    const list = el?.closest(".guest-list");
    if (!list) return;

    const after = getDragAfterElement(list, t.clientY);
    after ? list.insertBefore(placeholder, after) : list.appendChild(placeholder);

    updateDropHints();

    /* Auto scroll */
    if (t.clientY < 80) window.scrollBy(0, -10);
    if (window.innerHeight - t.clientY < 80) window.scrollBy(0, 10);
  }, { passive: false });

  /* K·∫øt th√∫c k√©o */
  document.addEventListener("touchend", () => {
    if (!touchItem) return;

    placeholder.parentElement.insertBefore(touchItem, placeholder);
    touchItem.style.visibility = "";
    placeholder.remove();

    if (touchClone) touchClone.remove();

    touchItem = null;
    touchClone = null;

    clearDropHints();
    document.querySelectorAll(".table").forEach(updateTable);
    saveState();
    updateUnassignedView();
  });

  /* H·ªßy k√©o */
  document.addEventListener("touchcancel", () => {
    if (touchClone) touchClone.remove();
    touchClone = null;

    if (touchItem) {
      touchItem.style.visibility = "";
    }

    touchItem = null;
    placeholder.remove();
    clearDropHints();
    updateUnassignedView();
  });
}
/* =======================
   B∆Ø·ªöC 6 ‚Äî ANDROID MODE
   Tap ch·ªçn kh√°ch ‚Üí Tap b√†n
   ======================= */

/* Android: ch·ªçn kh√°ch b·∫±ng c√°ch tap */
document.addEventListener("click", e => {
  if (!isAndroid) return;

  const li = e.target.closest(".guest-list li");
  if (!li || li.classList.contains("drag-placeholder")) return;

  /* Kh√¥ng ch·ªçn khi ƒëang x√≥a ho·∫∑c s·ª≠a t√™n */
  if (deleteMode) return;
  if (editNamesMode) return;

  /* B·∫•m l·∫°i ƒë·ªÉ b·ªè ch·ªçn */
  if (selectedGuest === li) {
    clearSelectedGuest();
    return;
  }

  /* Ch·ªçn kh√°ch */
  clearSelectedGuest();
  selectedGuest = li;
  li.classList.add("selected-guest");
});

/* Android: tap v√†o b√†n ƒë·ªÉ ƒë∆∞a kh√°ch v√†o b√†n */
tablesEl.addEventListener("click", e => {
  if (!isAndroid) return;

  const table = e.target.closest(".table");
  if (!table) return;

  /* Kh√¥ng x·ª≠ l√Ω n·∫øu kh√¥ng c√≥ kh√°ch ƒë∆∞·ª£c ch·ªçn */
  if (!selectedGuest) return;

  /* Kh√¥ng x·ª≠ l√Ω khi ƒëang s·ª≠a t√™n ho·∫∑c x√≥a */
  if (editNamesMode || deleteMode) return;

  const list = table.querySelector(".guest-list");
  const max = parseInt(table.dataset.max, 10);
  const count = list.querySelectorAll("li:not(.drag-placeholder)").length;

  if (count >= max) {
    alert("B√†n ƒë√£ ƒë·ªß ng∆∞·ªùi!");
    return;
  }

  /* Chuy·ªÉn kh√°ch v√†o b√†n */
  list.appendChild(selectedGuest);
  clearSelectedGuest();

  document.querySelectorAll(".table").forEach(updateTable);
  saveState();
  updateUnassignedView();
});

/* Android: ch·∫∑n m·ªçi h√†nh vi k√©o‚Äëth·∫£ m·∫∑c ƒë·ªãnh */
if (isAndroid) {
  document.addEventListener("touchstart", e => {
    const li = e.target.closest("li");
    if (!li) return;

    // Kh√¥ng ch·∫∑n click khi s·ª≠a t√™n
    if (editNamesMode) return;

    // Ch·ªâ ch·∫∑n drag m·∫∑c ƒë·ªãnh
    li.draggable = false;
  }, { passive: true });
}

/* =======================
   B∆Ø·ªöC 7 ‚Äî DELETE MODE
   ======================= */

const deleteBtn = document.getElementById("delete-mode-btn");
const deleteConfirmBtn = document.getElementById("delete-confirm-btn");
const deleteCancelBtn = document.getElementById("delete-cancel-btn");

deleteBtn.onclick = () => {
  deleteMode = true;
  clearSelectedGuest();
  document.body.classList.add("delete-mode");

  deleteBtn.classList.add("hidden");
  deleteConfirmBtn.classList.remove("hidden");
  deleteCancelBtn.classList.remove("hidden");

  document.querySelectorAll(".guest-list li:not(.drag-placeholder)").forEach(li => {
    if (!li.querySelector(".delete-x")) {
      const x = document.createElement("span");
      x.textContent = "‚úñ";
      x.className = "delete-x";
      li.appendChild(x);
    }
    li.classList.remove("marked-delete");
  });
};

deleteCancelBtn.onclick = () => {
  deleteMode = false;
  document.body.classList.remove("delete-mode");

  deleteBtn.classList.remove("hidden");
  deleteConfirmBtn.classList.add("hidden");
  deleteCancelBtn.classList.add("hidden");

  document.querySelectorAll(".delete-x").forEach(x => x.remove());
  document.querySelectorAll(".marked-delete").forEach(li => li.classList.remove("marked-delete"));
};

deleteConfirmBtn.onclick = () => {
  if (!confirm("X√≥a c√°c kh√°ch m·ªùi ƒë√£ ch·ªçn?")) return;

  document.querySelectorAll(".marked-delete").forEach(li => li.remove());

  deleteCancelBtn.onclick(); // reset mode
  document.querySelectorAll(".table").forEach(updateTable);
  saveState();
  updateUnassignedView();
};

/* Click v√†o d·∫•u X ƒë·ªÉ ƒë√°nh d·∫•u */
document.addEventListener("click", e => {
  if (!deleteMode) return;
  if (e.target.classList.contains("delete-x")) {
    e.target.closest("li").classList.toggle("marked-delete");
  }
});


/* =======================
   B∆Ø·ªöC 7 ‚Äî EDIT NAME MODE
   ======================= */

let originalNames = new Map();

const editBtn = document.getElementById("edit-names-btn");
const editSave = document.getElementById("edit-names-save");
const editCancel = document.getElementById("edit-names-cancel");

editBtn.onclick = () => {
  editNamesMode = true;
  clearSelectedGuest();
  document.body.classList.add("edit-names-mode");

  // Kh√≥a toolbar
  document.getElementById("toolbar-blocker").style.display = "block";

  editBtn.classList.add("hidden");
  editSave.classList.remove("hidden");
  editCancel.classList.remove("hidden");

  // L∆∞u t√™n g·ªëc
  originalNames.clear();
  document.querySelectorAll(".guest-list li").forEach(li => {
    originalNames.set(li, li.dataset.name);
    li.contentEditable = "true";
  });

  // T·∫Øt k√©o th·∫£ (Android v·∫´n t·∫Øt)
  document.querySelectorAll(".guest-list li").forEach(li => {
    li.draggable = !isAndroid ? false : false;
  });

  updateUnassignedView();
};

editCancel.onclick = () => {
  // 1) Kh√¥i ph·ª•c t√™n c≈© tr∆∞·ªõc
  originalNames.forEach((oldName, li) => {
    li.dataset.name = oldName;
    li.textContent = oldName;
    li.contentEditable = "false";
  });

  // 2) T·∫Øt ch·∫ø ƒë·ªô s·ª≠a
  editNamesMode = false;
  document.body.classList.remove("edit-names-mode");
  document.getElementById("toolbar-blocker").style.display = "none";

  // 3) Kh√¥i ph·ª•c draggable
  document.querySelectorAll(".guest-list li").forEach(li => {
    li.draggable = !isAndroid;
  });

  // 4) Kh√¥i ph·ª•c n√∫t
  editBtn.classList.remove("hidden");
  editSave.classList.add("hidden");
  editCancel.classList.add("hidden");

  // 5) C·∫≠p nh·∫≠t giao di·ªán
  document.querySelectorAll(".table").forEach(updateTable);
  updateUnassignedView();
};
editSave.onclick = () => {
  // 1) L∆∞u t√™n m·ªõi tr∆∞·ªõc
  document.querySelectorAll(".guest-list li").forEach(li => {
    const newName = normalizeName(li.textContent.trim());
    li.dataset.name = newName;
    li.textContent = newName;
    li.contentEditable = "false";
  });

  // 2) T·∫Øt ch·∫ø ƒë·ªô s·ª≠a
  editNamesMode = false;
  document.body.classList.remove("edit-names-mode");
  document.getElementById("toolbar-blocker").style.display = "none";

  // 3) Kh√¥i ph·ª•c draggable
  document.querySelectorAll(".guest-list li").forEach(li => {
    li.draggable = !isAndroid;
  });

  // 4) Kh√¥i ph·ª•c n√∫t
  editBtn.classList.remove("hidden");
  editSave.classList.add("hidden");
  editCancel.classList.add("hidden");

  // 5) C·∫≠p nh·∫≠t giao di·ªán
  document.querySelectorAll(".table").forEach(updateTable);
  saveState();
  updateUnassignedView();
};

/* =======================
   B∆Ø·ªöC 8 ‚Äî SAVE / LOAD
   ======================= */

document.getElementById("save-btn").onclick = () => {
  saveState();
  alert("ƒê√£ l∆∞u!");
};

document.getElementById("clear-btn").onclick = () => {
  if (confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu?")) {
    localStorage.removeItem("wedding_state");
    location.reload();
  }
};

function saveState() {
  const state = {
    tables: [...document.querySelectorAll(".table")].map(t => ({
      name: t.dataset.baseName,
      max: t.dataset.max,
      guests: [...t.querySelectorAll(".guest-list li:not(.drag-placeholder)")]
        .map(li => guestNameFromLi(li))
    })),
    unassigned: [...unassigned.querySelectorAll("li:not(.drag-placeholder)")]
      .map(li => guestNameFromLi(li))
  };

  localStorage.setItem("wedding_state", JSON.stringify(state));
}

/* Load d·ªØ li·ªáu khi m·ªü trang */
(function load() {
  const raw = localStorage.getItem("wedding_state");
  if (!raw) {
    createTable("B√†n 1");
    updateSummary();
    return;
  }

  const s = JSON.parse(raw);

  s.tables.forEach(t => createTable(t.name, t.max, t.guests));
  s.unassigned.forEach(n => unassigned.appendChild(createGuestLi(n)));

  document.querySelectorAll(".table").forEach(updateTable);
  updateUnassignedView();
})();


/* =======================
   B∆Ø·ªöC 8 ‚Äî IMPORT CSV
   ======================= */

document.getElementById("import-btn").onclick = () => {
  document.getElementById("import-csv").click();
};

document.getElementById("import-csv").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => parseCSV(reader.result);
  reader.readAsText(file, "utf-8");

  e.target.value = ""; // reset input
});

function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  if (lines.length < 2) return alert("CSV kh√¥ng h·ª£p l·ªá");

  const headers = lines[0].split(",").map(h => h.trim().toLowerCase());
  const idxName = headers.indexOf("t√™n kh√°ch");
  const idxTable = headers.indexOf("b√†n");

  if (idxName === -1) return alert("CSV ph·∫£i c√≥ c·ªôt 'T√™n kh√°ch'");

  lines.slice(1).forEach(line => {
    const cols = line.split(",").map(c => stripQuotes(c));
    const name = normalizeName(cols[idxName]);
    if (!name) return;

    if (idxTable !== -1 && cols[idxTable]) {
      const tableName = normalizeName(stripQuotes(cols[idxTable]));
      let table = [...document.querySelectorAll(".table")]
        .find(t => t.dataset.baseName === tableName);

      if (!table) {
        createTable(tableName);
        table = [...document.querySelectorAll(".table")]
          .find(t => t.dataset.baseName === tableName);
      }

      table.querySelector(".guest-list").appendChild(createGuestLi(name));
      updateTable(table);
    } else {
      unassigned.appendChild(createGuestLi(name));
    }
  });

  saveState();
  updateSummary();
  updateUnassignedView();
}


/* =======================
   B∆Ø·ªöC 8 ‚Äî EXPORT MENU
   ======================= */

exportBtn.onclick = () => {
  exportMenu.style.display =
    exportMenu.style.display === "flex" ? "none" : "flex";
};

document.addEventListener("click", e => {
  if (!exportMenu.contains(e.target) && e.target !== exportBtn) {
    exportMenu.style.display = "none";
  }
});


/* =======================
   B∆Ø·ªöC 8 ‚Äî HELP MODAL
   ======================= */

const helpModal = document.getElementById("help-modal");

document.getElementById("help-btn").onclick = () => {
  helpModal.style.display = "flex";
};

document.getElementById("help-close").onclick = () => {
  helpModal.style.display = "none";
};

/* =======================
   EXPORT CSV
   ======================= */
document.getElementById("export-csv").onclick = () => {
  exportMenu.style.display = "none";

  let rows = [["T√™n kh√°ch", "B√†n"]];
  document.querySelectorAll(".table").forEach(t => {
    const tableName = t.dataset.baseName;
    t.querySelectorAll(".guest-list li:not(.drag-placeholder)").forEach(li => {
      rows.push([li.dataset.name, tableName]);
    });
  });

  unassigned.querySelectorAll("li:not(.drag-placeholder)").forEach(li => {
    rows.push([li.dataset.name, ""]);
  });

  const csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "danhsach.csv";
  a.click();
};

/* =======================
   EXPORT PDF T·∫§T C·∫¢
   ======================= */
document.getElementById("export-pdf-all").onclick = () => {
  exportMenu.style.display = "none";
  window.print();
};

/* =======================
   EXPORT PDF 1 B√ÄN
   ======================= */
document.getElementById("export-pdf-one").onclick = () => {
  exportMenu.style.display = "none";

  pdfTableSelect.innerHTML = "";
  document.querySelectorAll(".table").forEach((t, i) => {
    const opt = document.createElement("option");
    opt.value = i;
    opt.textContent = t.dataset.baseName;
    pdfTableSelect.appendChild(opt);
  });

  pdfOneModal.style.display = "flex";
};

document.getElementById("pdf-one-cancel").onclick = () => {
  pdfOneModal.style.display = "none";
};

document.getElementById("pdf-one-export").onclick = () => {
  const index = pdfTableSelect.value;
  const table = document.querySelectorAll(".table")[index];

  printRoot.innerHTML = "";
  printRoot.appendChild(table.cloneNode(true));
  printRoot.style.display = "block";

  window.print();

  printRoot.style.display = "none";
  pdfOneModal.style.display = "none";
};

  </script>
</body>
</html>
