<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <title>S·∫Øp x·∫øp b√†n ti·ªác</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:Arial,Helvetica,sans-serif;
      background:#f4f6fb;
      color:#111;
      -webkit-tap-highlight-color: transparent;
    }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns:4fr 1.2fr;
      height:100vh;
      gap:12px;
      padding:12px
    }

    /* Toolbar */
    .toolbar{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap
    }
    .btn{
      padding:8px 12px;
      border-radius:8px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer;
      font-weight:bold;
      user-select:none;
    }
    .btn:hover{background:#eee}
    #add-table{
      font-size:22px;
      background:#111;
      color:#fff;
      border:none
    }
    #clear-btn{
      border-color:#dc2626;
      color:#dc2626
    }
    #clear-btn:hover{
      background:#dc2626;
      color:#fff
    }

    /* Summary */
    #summary{
      margin-left:auto;
      font-weight:bold
    }

    /* Export */
    .export-menu{position:relative}
    .export-dropdown{
      position:absolute;
      top:110%;
      left:0;
      background:#fff;
      border:1px solid #ccc;
      border-radius:10px;
      padding:6px;
      display:none;
      flex-direction:column;
      gap:4px;
      z-index:10;
      min-width:200px
    }
    .export-dropdown button{text-align:left}

    /* Tables */
    .tables{
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(260px,1fr));
      gap:12px;
      overflow:auto;
      margin-top:10px
    }
    .table{
      background:#fff;
      border-radius:12px;
      padding:10px;
      border:1px solid #ddd;
      display:flex;
      flex-direction:column;
      position:relative;
    }
    .table.over{
      background:#fee2e2;
      border:2px solid #dc2626
    }

    /* Color accents */
    .table:nth-child(4n+1){border-top:4px solid #2563eb}
    .table:nth-child(4n+2){border-top:4px solid #16a34a}
    .table:nth-child(4n+3){border-top:4px solid #f59e0b}
    .table:nth-child(4n+4){border-top:4px solid #dc2626}

    .table-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:6px;
      padding-bottom:6px;
      border-bottom:1px solid #eee
    }
    .table-title{
      margin:0;
      font-size:15px;
      outline:none
    }
    .table-actions{display:flex;gap:4px}
    .table-actions button{
      padding:6px 8px;
      border-radius:8px;
      border:1px solid #ccc;
      background:#fff;
      cursor:pointer
    }

    /* Guest list */
    .guest-list{
      list-style:none;
      padding:6px;
      margin:8px 0;
      border:2px dashed #ccc;
      min-height:80px;
      border-radius:8px;
      counter-reset:guest;
    }
    .guest-list li{
      background:#fff;
      border:1px solid #ccc;
      border-radius:6px;
      padding:8px 12px;
      margin-bottom:4px;
      cursor:grab;
      position:relative;
      user-select:none;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .guest-list li:not(.drag-placeholder)::before{
      counter-increment:guest;
      content: counter(guest) ".";
      display:inline-block;
      min-width:28px;
      margin-right:6px;
      color:#555;
      font-weight:bold;
    }

    /* Guest name */
    .guest-name{
      flex:1;
      display:inline-block;
      user-select:none;
    }

    /* M≈©i t√™n Android */
    .move-arrow{
      display:none;
      font-size:22px;
      padding:4px 6px;
      background:#eee;
      border-radius:6px;
      user-select:none;
    }
    li.selected-guest .move-arrow{
      display:inline-block;
    }

    /* Delete X */
    .delete-x{
      font-size:22px !important;
      cursor:pointer;
      color:#dc2626;
      margin-left:8px;
      user-select:none;
    }
    .delete-mode li .delete-x{display:inline-block}
    .marked-delete{opacity:.4;text-decoration:line-through}

    /* Drag UI */
    .drag-placeholder{
      height:32px;
      margin-bottom:4px;
      border:2px dashed #2563eb;
      border-radius:6px;
      background:rgba(37,99,235,.08);
    }
    .dragging{opacity:.4}

    /* Touch drag */
    @media (pointer: coarse){
      .guest-list li{touch-action:none}
    }
    .touch-dragging{
      position:fixed;
      z-index:10000;
      pointer-events:none;
      opacity:.85;
      transform:scale(1.05);
      box-shadow:0 8px 20px rgba(0,0,0,.25);
      background:#fef3c7;
    }

    /* Sidebar */
    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: 100%;
      overflow: hidden;
    }

    .quick-add {
      background: #fff;
      border-radius: 12px;
      border: 1px solid #ddd;
      padding: 10px;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .quick-add textarea {
      width:100%;
      height:90px;
      resize:vertical;
      border-radius:8px;
      padding:8px;
    }

    .unassigned-card {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0;
      background:#fff;
      border-radius:12px;
      border:1px solid #ddd;
    }

    .unassigned-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      padding:10px;
      border-bottom:1px solid #eee;
      background:#fafafa;
      position:sticky;
      top:0;
      z-index:5;
    }

    .unassigned-scroll {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding:10px;
    }

    /* Modal */
    .modal{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.4);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1000;
    }
    .modal-content{
      background:#fff;
      padding:16px;
      border-radius:14px;
      width:360px;
      max-width:90vw;
      max-height:80vh;
      overflow:auto;
    }

    /* Print */
    @media print{
      body *{visibility:hidden}
      #print-root, #print-root *{visibility:visible}
      #print-root{position:absolute;inset:0;padding:12px}
      .table{page-break-before:always}
      @page{size:A4;margin:10mm}
    }

    #print-root{
      position:fixed;
      inset:0;
      background:#fff;
      z-index:9999;
      display:none;
      overflow:auto;
      padding:12px
    }

  .hidden {
  display: none !important;
}
    
@media print {
  body * { visibility: hidden; }
  #print-root, #print-root * { visibility: visible; }
  #print-root { position: absolute; inset: 0; padding: 0; }
}

  </style>
</head>
<body>

  <div class="layout">

    <!-- ==========================
         KH·ªêI TR√ÅI: B√ÄN TI·ªÜC
         ========================== -->
    <div>
      <div class="toolbar">

        <button id="add-table">+</button>
        <button id="adjust-max" class="btn">‚öôÔ∏è Ch·ªânh max</button>

        <button id="edit-names-btn" class="btn edit-only">‚úèÔ∏è S·ª≠a t√™n kh√°ch</button>
        <button id="edit-names-save" class="btn hidden edit-only">üíæ ƒê·ªìng √Ω</button>
        <button id="edit-names-cancel" class="btn hidden edit-only">‚ùå H·ªßy</button>

        <button id="save-btn" class="btn">üíæ L∆∞u</button>
        <button id="clear-btn" class="btn">üßπ X√≥a</button>

        <input type="file" id="import-csv" accept=".csv" hidden>
        <button id="import-btn" class="btn">üì• Import CSV</button>

        <div class="export-menu">
          <button id="export-btn" class="btn">üì§ Xu·∫•t</button>
          <div id="export-menu" class="export-dropdown">
            <button id="export-csv">üìä Excel (CSV)</button>
            <button id="export-pdf-all">üñ®Ô∏è PDF t·∫•t c·∫£</button>
            <button id="export-pdf-one">üßæ PDF 1 b√†n</button>
          </div>
        </div>

        <button id="help-btn" class="btn">‚ùì H∆∞·ªõng d·∫´n</button>

        <div id="summary">
          T·ªïng: <span id="total-guests">0</span> kh√°ch ¬∑
          <span id="total-tables">0</span> b√†n
        </div>
      </div>

      <div id="toolbar-blocker"></div>

      <div class="tables" id="tables"></div>
    </div>

    <!-- ==========================
         KH·ªêI PH·∫¢I: SIDEBAR
         ========================== -->
    <div class="sidebar">

      <!-- TH√äM KH√ÅCH NHANH -->
      <div class="quick-add">
        <h3>Th√™m kh√°ch</h3>
        <textarea id="guest-input" placeholder="M·ªói d√≤ng l√† 1 t√™n..."></textarea>
        <button id="add-guest" class="btn">Th√™m</button>
      </div>

      <!-- CH∆ØA S·∫ÆP X·∫æP -->
      <div class="unassigned-card">
        <div class="unassigned-header">
          <h3>Ch∆∞a s·∫Øp x·∫øp</h3>
          <div>
            <button id="delete-mode-btn" class="btn">üóëÔ∏è</button>
            <button id="delete-confirm-btn" class="btn hidden">‚úÖ</button>
            <button id="delete-cancel-btn" class="btn hidden">‚ùå</button>
          </div>
        </div>

        <div class="unassigned-scroll">
          <ul class="guest-list" id="unassigned"></ul>
        </div>
      </div>

    </div>
  </div>

  <!-- ==========================
       MODAL: CH·ªàNH MAX
       ========================== -->
  <div class="modal" id="max-modal">
    <div class="modal-content">
      <h3>Ch·ªânh s·ªë kh√°ch t·ªëi ƒëa</h3>

      <div style="margin-bottom:10px">
        <label><b>Ch·ªânh h√†ng lo·∫°t:</b></label>
        <input type="number" id="bulk-max" min="1" placeholder="Nh·∫≠p s·ªë kh√°ch t·ªëi ƒëa..."
          style="width:100%;padding:6px;border-radius:6px;border:1px solid #ccc;margin-top:4px">
        <div style="font-size:12px;color:#666;margin-top:2px">
          Khi nh·∫≠p s·ªë v√†o ƒë√¢y, t·∫•t c·∫£ b√†n s·∫Ω c√≥ s·ªë kh√°ch t·ªëi ƒëa gi·ªëng nhau.
        </div>
      </div>

      <div id="max-list"></div>

      <div class="modal-actions" style="margin-top:14px;display:flex;justify-content:flex-end;gap:8px">
        <button id="max-cancel" class="btn">H·ªßy</button>
        <button id="max-save" class="btn">L∆∞u</button>
      </div>
    </div>
  </div>

  <!-- ==========================
       MODAL: PDF 1 B√ÄN
       ========================== -->
  <div class="modal" id="pdf-one-modal">
    <div class="modal-content">
      <h3>Xu·∫•t PDF 1 b√†n</h3>

      <select id="pdf-table-select"
        style="width:100%;padding:8px;border-radius:8px;margin-top:10px;margin-bottom:10px"></select>

      <div class="modal-actions" style="display:flex;justify-content:flex-end;gap:8px">
        <button id="pdf-one-cancel" class="btn">H·ªßy</button>
        <button id="pdf-one-export" class="btn">Xu·∫•t</button>
      </div>
    </div>
  </div>

  <!-- ==========================
       MODAL: H∆Ø·ªöNG D·∫™N
       ========================== -->
  <div class="modal" id="help-modal">
    <div class="modal-content">
      <h3>H∆∞·ªõng d·∫´n s·ª≠ d·ª•ng</h3>

      <div id="help-content" style="max-height:60vh;overflow:auto;line-height:1.5">
        <h4>1. T·∫°o b√†n</h4>
        <p>B·∫•m n√∫t <b>+</b> ƒë·ªÉ t·∫°o th√™m b√†n m·ªõi.</p>

        <h4>2. Ch·ªânh s·ªë kh√°ch t·ªëi ƒëa</h4>
        <p>B·∫•m <b>‚öôÔ∏è Ch·ªânh max</b> ƒë·ªÉ thay ƒë·ªïi s·ªë kh√°ch t·ªëi ƒëa c·ªßa t·ª´ng b√†n.</p>

        <h4>3. L∆∞u d·ªØ li·ªáu</h4>
        <p>B·∫•m <b>üíæ L∆∞u</b> ƒë·ªÉ l∆∞u to√†n b·ªô b·ªë c·ª•c v√†o tr√¨nh duy·ªát.</p>

        <h4>4. Xu·∫•t d·ªØ li·ªáu</h4>
        <p>D√πng menu <b>üì§ Xu·∫•t</b> ƒë·ªÉ xu·∫•t CSV, PDF t·∫•t c·∫£ ho·∫∑c PDF t·ª´ng b√†n.</p>

        <h4>5. Import CSV</h4>
        <p>B·∫•m <b>üì• Import CSV</b> ƒë·ªÉ nh·∫≠p danh s√°ch kh√°ch t·ª´ file CSV.</p>

        <h4>6. Th√™m kh√°ch v√†o b√†n</h4>
        <p>B·∫•m n√∫t <b>‚ûï</b> tr√™n m·ªói b√†n ƒë·ªÉ th√™m kh√°ch nhanh.</p>

        <h4>7. Th√™m kh√°ch nhanh</h4>
        <p>Nh·∫≠p nhi·ªÅu t√™n v√†o √¥ ‚ÄúTh√™m kh√°ch‚Äù (m·ªói d√≤ng 1 t√™n) r·ªìi b·∫•m <b>Th√™m</b>.</p>

        <h4>8. K√©o‚Äëth·∫£ kh√°ch</h4>
        <p>K√©o kh√°ch gi·ªØa c√°c b√†n ho·∫∑c t·ª´ ‚ÄúCh∆∞a s·∫Øp x·∫øp‚Äù ƒë·ªÉ b·ªë tr√≠ ch·ªó ng·ªìi.</p>
      </div>

      <div class="modal-actions" style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="help-close" class="btn">Tr·ªü v·ªÅ</button>
      </div>
    </div>
  </div>

  <!-- ==========================
       MODAL: MOVE KH√ÅCH
       ========================== -->
  <div id="move-modal" class="modal">
    <div class="modal-content">
      <h3>Ch·ªçn b√†n</h3>
      <div id="move-list" style="display:flex;flex-direction:column;gap:8px;margin-top:10px"></div>
      <div class="modal-actions" style="display:flex;justify-content:flex-end;gap:8px;margin-top:10px">
        <button id="move-cancel" class="btn">H·ªßy</button>
      </div>
    </div>
  </div>

  <!-- ROOT IN PDF -->
  <div id="print-root"></div>
<script>
/* =======================
   B∆Ø·ªöC 1 ‚Äî KH·ªûI T·∫†O BI·∫æN
   ======================= */

const tablesEl = document.getElementById("tables");
const unassigned = document.getElementById("unassigned");
const guestInput = document.getElementById("guest-input");
const exportBtn = document.getElementById("export-btn");
const exportMenu = document.getElementById("export-menu");
const printRoot = document.getElementById("print-root");

const maxModal = document.getElementById("max-modal");
const maxList = document.getElementById("max-list");

const pdfOneModal = document.getElementById("pdf-one-modal");
const pdfTableSelect = document.getElementById("pdf-table-select");

const isTouch = ("ontouchstart" in window) || (navigator.maxTouchPoints > 0);
const isAndroid = /Android/i.test(navigator.userAgent || "");

let editNamesMode = false;
let deleteMode = false;
let selectedGuest = null;

/* =======================
   B∆Ø·ªöC 1 ‚Äî HELPER
   ======================= */

function normalizeName(s){
  return String(s||"").trim().replace(/\s+/g," ");
}

function stripQuotes(s){
  return String(s || "").replace(/^"(.*)"$/, "$1").trim();
}

function guestNameFromLi(li){
  return li.dataset.name || normalizeName(li.textContent);
}

/* =======================
   T·∫†O 1 KH√ÅCH <li> ‚Äî B·∫¢N FIX
   ======================= */

function createGuestLi(name){
  const clean = normalizeName(name);
  const li = document.createElement("li");
  li.dataset.name = clean;

  const span = document.createElement("span");
  span.className = "guest-name";
  span.textContent = clean;
  li.appendChild(span);

  li.draggable = !isAndroid;

  if (isAndroid) {
    li.style.userSelect = "none";
    li.style.webkitUserSelect = "none";
    li.style.webkitUserDrag = "none";
    li.style.touchAction = "manipulation";

    const arrow = document.createElement("span");
    arrow.className = "move-arrow";
    arrow.textContent = "‚û°Ô∏è";
    li.appendChild(arrow);
  }

  return li;
}

/* =======================
   R√öT G·ªåN T√äN
   ======================= */

function shortName(full){
  const parts = full.trim().split(/\s+/);
  if(parts.length <= 2) return full;
  return parts.slice(-2).join(" ");
}

function clearSelectedGuest(){
  if(selectedGuest){
    selectedGuest.classList.remove("selected-guest");
    selectedGuest = null;
  }
}

/* =======================
   B∆Ø·ªöC 2 ‚Äî T·∫†O B√ÄN
   ======================= */

function createTable(name, max = 10, guests = []) {
  const table = document.createElement("div");
  table.className = "table";
  table.dataset.max = String(max);
  table.dataset.baseName = normalizeName(name) || "B√†n";

  table.innerHTML = `
    <div class="table-header">
      <h3 class="table-title"></h3>
      <div class="table-actions">
        <button class="quick-add-btn">‚ûï</button>
        <button class="edit-table-btn">‚úèÔ∏è</button>
        <button class="delete-table-btn">üóëÔ∏è</button>
      </div>
    </div>

    <div class="quick-add hidden">
      <input class="quick-add-input" placeholder="Nh·∫≠p t√™n kh√°ch..." />
      <div class="quick-add-hint">Enter ¬∑ Esc</div>
    </div>

    <ul class="guest-list"></ul>
    <div class="table-warning hidden"></div>
  `;

  const ul = table.querySelector(".guest-list");
  guests.forEach(g => ul.appendChild(createGuestLi(g)));

  tablesEl.appendChild(table);
  updateTable(table);
}

/* =======================
   UPDATE B√ÄN ‚Äî B·∫¢N FIX
   ======================= */

function updateTable(table) {
  const list = table.querySelector(".guest-list");

  list.querySelectorAll("li:not(.drag-placeholder)").forEach(li => {
    const span = li.querySelector(".guest-name");
    if (span) span.textContent = li.dataset.name;
  });

  const count = list.querySelectorAll("li:not(.drag-placeholder)").length;
  const max = parseInt(table.dataset.max, 10);
  const name = normalizeName(table.dataset.baseName || "B√†n");

  table.querySelector(".table-title").textContent = `${name} (${count}/${max})`;

  const warning = table.querySelector(".table-warning");

  if (count > max) {
    table.classList.add("over");
    warning.innerHTML = `‚ö†Ô∏è B√†n ƒë√£ d∆∞ ng∆∞·ªùi (${count - max})<br>
      <button class="auto-fix-btn">Auto ƒë∆∞a v·ªÅ Ch∆∞a s·∫Øp x·∫øp</button>`;
    warning.classList.remove("hidden");
  } else {
    table.classList.remove("over");
    warning.classList.add("hidden");
    warning.innerHTML = "";
  }

  updateSummary();
}

/* =======================
   UPDATE T·ªîNG
   ======================= */

function updateSummary() {
  document.getElementById("total-tables").textContent =
    document.querySelectorAll(".table").length;

  document.getElementById("total-guests").textContent =
    document.querySelectorAll(".guest-list li:not(.drag-placeholder)").length;
}

/* =======================
   UPDATE UNASSIGNED ‚Äî B·∫¢N FIX
   ======================= */

function updateUnassignedView() {
  const list = document.getElementById("unassigned");
  const items = [...list.querySelectorAll("li:not(.drag-placeholder)")];
  const count = items.length;

  const setLiText = (li, text) => {
    const span = li.querySelector(".guest-name");
    if (span) span.textContent = text;
  };

  if (editNamesMode) {
    items.forEach(li => setLiText(li, li.dataset.name));
    list.style.display = count < 20 ? "block" : "grid";
    list.style.gridTemplateColumns = count < 20 ? "" : "repeat(2,1fr)";
    return;
  }

  items.forEach(li => setLiText(li, li.dataset.name));

  if (count < 20) {
    list.style.display = "block";
    list.style.gridTemplateColumns = "";
    return;
  }

  items.forEach(li => setLiText(li, shortName(li.dataset.name)));

  list.style.display = "grid";
  list.style.gridTemplateColumns = "repeat(2,1fr)";
}
</script>
<!-- =======================
     PH·∫¶N 4 ‚Äî DRAG / TOUCH / ANDROID / DELETE / EDIT NAME
     ======================= -->

<script>
/* =======================
   B∆Ø·ªöC 4 ‚Äî DRAG WINDOWS
   ======================= */

let draggedItem = null;
const placeholder = document.createElement("li");
placeholder.className = "drag-placeholder";

function getDragAfterElement(container, y) {
  const items = [...container.querySelectorAll("li:not(.dragging):not(.drag-placeholder)")];
  return items.reduce((closest, child) => {
    const box = child.getBoundingClientRect();
    const offset = y - box.top - box.height / 2;
    return (offset < 0 && offset > closest.offset)
      ? { offset, element: child }
      : closest;
  }, { offset: Number.NEGATIVE_INFINITY, element: null }).element;
}

if (!isAndroid) {
  document.addEventListener("dragstart", e => {
    if (e.target.tagName !== "LI") return;
    draggedItem = e.target;
    draggedItem.classList.add("dragging");
    e.dataTransfer.setData("", "");
  });

  document.addEventListener("dragover", e => {
    const list = e.target.closest(".guest-list");
    if (!list || !draggedItem) return;
    e.preventDefault();
    const after = getDragAfterElement(list, e.clientY);
    after ? list.insertBefore(placeholder, after) : list.appendChild(placeholder);
  });

  document.addEventListener("drop", e => {
    const list = e.target.closest(".guest-list");
    if (!list || !draggedItem) return;
    e.preventDefault();
    list.insertBefore(draggedItem, placeholder);
    placeholder.remove();
    draggedItem.classList.remove("dragging");
    draggedItem = null;
    document.querySelectorAll(".table").forEach(updateTable);
    saveState();
    setTimeout(updateUnassignedView, 0);
  });

  document.addEventListener("dragend", () => {
    placeholder.remove();
    setTimeout(updateUnassignedView, 0);
  });
}

/* =======================
   B∆Ø·ªöC 5 ‚Äî TOUCH DRAG (WINDOWS TOUCH)
   ======================= */

if (isTouch && !isAndroid) {
  let touchItem = null;
  let touchClone = null;
  let timer = null;

  document.addEventListener("touchstart", e => {
    const li = e.target.closest(".guest-list li");
    if (!li) return;

    timer = setTimeout(() => {
      touchItem = li;
      const r = li.getBoundingClientRect();
      touchClone = li.cloneNode(true);
      touchClone.classList.add("touch-dragging");
      touchClone.style.width = r.width + "px";
      document.body.appendChild(touchClone);
      placeholder.style.height = r.height + "px";
      li.parentElement.insertBefore(placeholder, li);
      li.style.visibility = "hidden";
    }, 200);
  }, { passive: false });

  document.addEventListener("touchmove", e => {
    if (timer) { clearTimeout(timer); timer = null; }
    if (!touchItem || !touchClone) return;
    e.preventDefault();
    const t = e.touches[0];
    touchClone.style.left = t.clientX - touchClone.offsetWidth / 2 + "px";
    touchClone.style.top = t.clientY - touchClone.offsetHeight / 2 + "px";
    const el = document.elementFromPoint(t.clientX, t.clientY);
    const list = el?.closest(".guest-list");
    if (!list) return;
    const after = getDragAfterElement(list, t.clientY);
    after ? list.insertBefore(placeholder, after) : list.appendChild(placeholder);
  }, { passive: false });

  document.addEventListener("touchend", () => {
    if (!touchItem) return;
    placeholder.parentElement.insertBefore(touchItem, placeholder);
    touchItem.style.visibility = "";
    placeholder.remove();
    if (touchClone) touchClone.remove();
    touchItem = null;
    touchClone = null;
    document.querySelectorAll(".table").forEach(updateTable);
    saveState();
    setTimeout(updateUnassignedView, 0);
  });
}

/* =======================
   B∆Ø·ªöC 6 ‚Äî ANDROID MODE
   ======================= */

document.addEventListener("click", e => {
  if (!isAndroid) return;

  const li = e.target.closest(".guest-list li");
  if (!li) return;

  if (deleteMode || editNamesMode) return;

  // N·∫øu b·∫•m v√†o m≈©i t√™n ‚Üí m·ªü modal ch·ªçn b√†n
  if (e.target.classList.contains("move-arrow")) {
    selectedGuest = li;
    li.classList.add("selected-guest");
    openMoveGuestModal(li);
    return;
  }

  // B·∫•m l·∫°i ƒë·ªÉ b·ªè ch·ªçn
  if (selectedGuest === li) {
    clearSelectedGuest();
    return;
  }

  clearSelectedGuest();
  selectedGuest = li;
  li.classList.add("selected-guest");
});

/* Android: tap b√†n ƒë·ªÉ chuy·ªÉn kh√°ch */
tablesEl.addEventListener("click", e => {
  if (!isAndroid) return;

  const table = e.target.closest(".table");
  if (!table) return;
  if (!selectedGuest) return;
  if (editNamesMode || deleteMode) return;

  const list = table.querySelector(".guest-list");
  const max = parseInt(table.dataset.max, 10);
  const count = list.querySelectorAll("li:not(.drag-placeholder)").length;

  if (count >= max) {
    alert("B√†n ƒë√£ ƒë·ªß ng∆∞·ªùi!");
    return;
  }

  list.appendChild(selectedGuest);
  clearSelectedGuest();
  document.querySelectorAll(".table").forEach(updateTable);
  saveState();
  updateUnassignedView();
});

/* Android: ch·∫∑n drag m·∫∑c ƒë·ªãnh */
if (isAndroid) {
  document.addEventListener("touchstart", e => {
    const li = e.target.closest("li");
    if (!li) return;
    if (editNamesMode) return;
    li.draggable = false;
    li.style.userSelect = "none";
    li.style.touchAction = "manipulation";
  }, { passive: true });
}

/* =======================
   B∆Ø·ªöC 7 ‚Äî DELETE MODE
   ======================= */

const deleteBtn = document.getElementById("delete-mode-btn");
const deleteConfirmBtn = document.getElementById("delete-confirm-btn");
const deleteCancelBtn = document.getElementById("delete-cancel-btn");

deleteBtn.onclick = () => {
  deleteMode = true;
  clearSelectedGuest();
  document.body.classList.add("delete-mode");

  deleteBtn.classList.add("hidden");
  deleteConfirmBtn.classList.remove("hidden");
  deleteCancelBtn.classList.remove("hidden");

  document.querySelectorAll(".guest-list li:not(.drag-placeholder)").forEach(li => {
    if (!li.querySelector(".delete-x")) {
      const x = document.createElement("span");
      x.textContent = "‚úñ";
      x.className = "delete-x";
      li.appendChild(x);
    }
    li.classList.remove("marked-delete");
  });
};

deleteCancelBtn.onclick = () => {
  deleteMode = false;
  document.body.classList.remove("delete-mode");

  deleteBtn.classList.remove("hidden");
  deleteConfirmBtn.classList.add("hidden");
  deleteCancelBtn.classList.add("hidden");

  document.querySelectorAll(".delete-x").forEach(x => x.remove());
  document.querySelectorAll(".marked-delete").forEach(li => li.classList.remove("marked-delete"));
};

deleteConfirmBtn.onclick = () => {
  if (!confirm("X√≥a c√°c kh√°ch m·ªùi ƒë√£ ch·ªçn?")) return;

  document.querySelectorAll(".marked-delete").forEach(li => li.remove());

  deleteCancelBtn.onclick();
  document.querySelectorAll(".table").forEach(updateTable);
  saveState();
  updateUnassignedView();
};

/* Click v√†o d·∫•u X */
document.addEventListener("click", e => {
  if (!deleteMode) return;
  if (e.target.classList.contains("delete-x")) {
    e.target.closest("li").classList.toggle("marked-delete");
  }
});

/* =======================
   B∆Ø·ªöC 7 ‚Äî EDIT NAME MODE (B·∫¢N FIX)
   ======================= */

let originalNames = new Map();

const editBtn = document.getElementById("edit-names-btn");
const editSave = document.getElementById("edit-names-save");
const editCancel = document.getElementById("edit-names-cancel");

editBtn.onclick = () => {
  editNamesMode = true;
  clearSelectedGuest();
  document.body.classList.add("edit-names-mode");
  document.getElementById("toolbar-blocker").style.pointerEvents = "auto";

  editBtn.classList.add("hidden");
  editSave.classList.remove("hidden");
  editCancel.classList.remove("hidden");

  originalNames.clear();
  document.querySelectorAll(".guest-list li").forEach(li => {
    originalNames.set(li, li.dataset.name);
    const span = li.querySelector(".guest-name");
    if (span) span.contentEditable = "true";
  });

  document.querySelectorAll(".guest-list li").forEach(li => {
    li.draggable = false;
  });

  updateUnassignedView();
};

editCancel.onclick = () => {
  originalNames.forEach((oldName, li) => {
    li.dataset.name = oldName;
    const span = li.querySelector(".guest-name");
    if (span) {
      span.textContent = oldName;
      span.contentEditable = "false";
    }
  });

  editNamesMode = false;
  document.body.classList.remove("edit-names-mode");
  document.getElementById("toolbar-blocker").style.pointerEvents = "none";

  document.querySelectorAll(".guest-list li").forEach(li => {
    li.draggable = !isAndroid;
  });

  editBtn.classList.remove("hidden");
  editSave.classList.add("hidden");
  editCancel.classList.add("hidden");

  document.querySelectorAll(".table").forEach(updateTable);
  updateUnassignedView();
};

editSave.onclick = () => {
  document.querySelectorAll(".guest-list li").forEach(li => {
    const span = li.querySelector(".guest-name");
    if (!span) return;
    const newName = normalizeName(span.textContent.trim());
    li.dataset.name = newName;
    span.textContent = newName;
    span.contentEditable = "false";
  });

  editNamesMode = false;
  document.body.classList.remove("edit-names-mode");
  document.getElementById("toolbar-blocker").style.pointerEvents = "none";

  document.querySelectorAll(".guest-list li").forEach(li => {
    li.draggable = !isAndroid;
  });

  editBtn.classList.remove("hidden");
  editSave.classList.add("hidden");
  editCancel.classList.add("hidden");

  document.querySelectorAll(".table").forEach(updateTable);
  saveState();
  updateUnassignedView();
};
</script>
<!-- =======================
     PH·∫¶N 5 ‚Äî SAVE / LOAD / IMPORT / EXPORT / ADD TABLE / MAX / MOVE
     ======================= -->

<script>
/* =======================
   SAVE / LOAD
   ======================= */

document.getElementById("save-btn").onclick = () => {
  saveState();
  alert("ƒê√£ l∆∞u!");
};

document.getElementById("clear-btn").onclick = () => {
  if (confirm("X√≥a to√†n b·ªô d·ªØ li·ªáu?")) {
    localStorage.removeItem("wedding_state");
    location.reload();
  }
};

function saveState() {
  const state = {
    tables: [...document.querySelectorAll(".table")].map(t => ({
      name: t.dataset.baseName,
      max: t.dataset.max,
      guests: [...t.querySelectorAll(".guest-list li:not(.drag-placeholder)")]
        .map(li => li.dataset.name)
    })),
    unassigned: [...unassigned.querySelectorAll("li:not(.drag-placeholder)")]
      .map(li => li.dataset.name)
  };

  localStorage.setItem("wedding_state", JSON.stringify(state));
}

/* Load d·ªØ li·ªáu khi m·ªü trang */
(function load() {
  const raw = localStorage.getItem("wedding_state");
  if (!raw) {
    createTable("B√†n 1");
    updateSummary();
    return;
  }

  let s;
  try {
    s = JSON.parse(raw);
  } catch (e) {
    console.error("L·ªói parse state, reset d·ªØ li·ªáu", e);
    localStorage.removeItem("wedding_state");
    createTable("B√†n 1");
    updateSummary();
    return;
  }

  if (!s.tables || !Array.isArray(s.tables)) {
    createTable("B√†n 1");
    updateSummary();
    return;
  }

  s.tables.forEach(t => createTable(t.name, t.max, t.guests || []));
  (s.unassigned || []).forEach(n => unassigned.appendChild(createGuestLi(n)));

  document.querySelectorAll(".table").forEach(updateTable);
  updateUnassignedView();
})();

/* =======================
   IMPORT CSV
   ======================= */

document.getElementById("import-btn").onclick = () => {
  document.getElementById("import-csv").click();
};

document.getElementById("import-csv").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = () => parseCSV(reader.result);
  reader.readAsText(file, "utf-8");

  e.target.value = "";
});

function parseCSV(text) {
  const lines = text.trim().split(/\r?\n/);
  if (lines.length < 2) return alert("CSV kh√¥ng h·ª£p l·ªá");

  const headers = lines[0].split(",").map(h => h.trim().toLowerCase());
  const idxName = headers.indexOf("t√™n kh√°ch");
  const idxTable = headers.indexOf("b√†n");

  if (idxName === -1) return alert("CSV ph·∫£i c√≥ c·ªôt 'T√™n kh√°ch'");

  lines.slice(1).forEach(line => {
    const cols = line.split(",").map(c => stripQuotes(c));
    const name = normalizeName(cols[idxName]);
    if (!name) return;

    if (idxTable !== -1 && cols[idxTable]) {
      const tableName = normalizeName(stripQuotes(cols[idxTable]));
      let table = [...document.querySelectorAll(".table")]
        .find(t => t.dataset.baseName === tableName);

      if (!table) {
        createTable(tableName);
        table = [...document.querySelectorAll(".table")]
          .find(t => t.dataset.baseName === tableName);
      }

      table.querySelector(".guest-list").appendChild(createGuestLi(name));
      updateTable(table);
    } else {
      unassigned.appendChild(createGuestLi(name));
    }
  });

  saveState();
  updateSummary();
  updateUnassignedView();
}

/* =======================
   EXPORT MENU
   ======================= */

exportBtn.onclick = () => {
  exportMenu.style.display =
    exportMenu.style.display === "flex" ? "none" : "flex";
};

document.addEventListener("click", e => {
  if (
    !exportMenu.contains(e.target) &&
    e.target !== exportBtn &&
    e.target.id !== "help-btn" && !e.target.closest(".modal")
  ) {
    exportMenu.style.display = "none";
  }
});

/* =======================
   EXPORT CSV
   ======================= */

document.getElementById("export-csv").onclick = () => {
  exportMenu.style.display = "none";

  let rows = [["T√™n kh√°ch", "B√†n"]];
  document.querySelectorAll(".table").forEach(t => {
    const tableName = t.dataset.baseName;
    t.querySelectorAll(".guest-list li:not(.drag-placeholder)").forEach(li => {
      rows.push([li.dataset.name, tableName]);
    });
  });

  unassigned.querySelectorAll("li:not(.drag-placeholder)").forEach(li => {
    rows.push([li.dataset.name, ""]);
  });

  const csv = rows.map(r => r.join(",")).join("\n");
  const blob = new Blob([csv], { type: "text/csv" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "danhsach.csv";
  a.click();
};

/* =======================
   EXPORT PDF T·∫§T C·∫¢ ‚Äî B·∫¢N ·ªîN ƒê·ªäNH
   ======================= */

document.getElementById("export-pdf-all").onclick = () => {
  exportMenu.style.display = "none";

  printRoot.innerHTML = "";
  printRoot.style.display = "block";

  // CSS ri√™ng cho print
  const style = document.createElement("style");
  style.textContent = `
    .print-page { page-break-after: always; padding: 20px; font-size: 16px; }
    .print-page h2 { margin: 0 0 10px 0; font-size: 22px; }
    .print-list li { padding: 4px 0; }
  `;
  printRoot.appendChild(style);

  // 1) Trang "Ch∆∞a s·∫Øp x·∫øp"
  const pageUn = document.createElement("div");
  pageUn.className = "print-page";
  pageUn.innerHTML = `<h2>Ch∆∞a s·∫Øp x·∫øp</h2>`;

  const ulUn = document.createElement("ul");
  ulUn.className = "print-list";

  [...unassigned.querySelectorAll("li:not(.drag-placeholder)")].forEach(li => {
    const item = document.createElement("li");
    item.textContent = li.dataset.name;
    ulUn.appendChild(item);
  });

  pageUn.appendChild(ulUn);
  printRoot.appendChild(pageUn);

  // 2) M·ªói b√†n = 1 trang
  document.querySelectorAll(".table").forEach(t => {
    const page = document.createElement("div");
    page.className = "print-page";

    page.innerHTML = `<h2>${t.dataset.baseName}</h2>`;

    const ul = document.createElement("ul");
    ul.className = "print-list";

    [...t.querySelectorAll(".guest-list li:not(.drag-placeholder)")].forEach(li => {
      const item = document.createElement("li");
      item.textContent = li.dataset.name;
      ul.appendChild(item);
    });

    page.appendChild(ul);
    printRoot.appendChild(page);
  });

  window.print();

  printRoot.style.display = "none";
  printRoot.innerHTML = "";
};

/* =======================
   EXPORT PDF 1 B√ÄN ‚Äî B·∫¢N ·ªîN ƒê·ªäNH
   ======================= */

document.getElementById("pdf-one-export").onclick = () => {
  const index = pdfTableSelect.value;
  const table = document.querySelectorAll(".table")[index];

  printRoot.innerHTML = "";
  printRoot.style.display = "block";

  const style = document.createElement("style");
  style.textContent = `
    .print-page { page-break-after: always; padding: 20px; font-size: 16px; }
    .print-page h2 { margin: 0 0 10px 0; font-size: 22px; }
    .print-list li { padding: 4px 0; }
  `;
  printRoot.appendChild(style);

  const page = document.createElement("div");
  page.className = "print-page";

  page.innerHTML = `<h2>${table.dataset.baseName}</h2>`;

  const ul = document.createElement("ul");
  ul.className = "print-list";

  [...table.querySelectorAll(".guest-list li:not(.drag-placeholder)")].forEach(li => {
    const item = document.createElement("li");
    item.textContent = li.dataset.name;
    ul.appendChild(item);
  });

  page.appendChild(ul);
  printRoot.appendChild(page);

  window.print();

  printRoot.style.display = "none";
  printRoot.innerHTML = "";
  pdfOneModal.style.display = "none";
};

/* =======================
   TH√äM B√ÄN
   ======================= */

document.getElementById("add-table").onclick = () => {
  const count = document.querySelectorAll(".table").length + 1;
  createTable("B√†n " + count);
  updateSummary();
  saveState();
};

/* =======================
   CH·ªàNH MAX
   ======================= */

document.getElementById("adjust-max").onclick = () => {
  maxList.innerHTML = "";

  document.querySelectorAll(".table").forEach((t, i) => {
    const row = document.createElement("div");
    row.className = "max-row";
    row.style.marginBottom = "8px";

    const name = t.dataset.baseName || ("B√†n " + (i + 1));
    const currentMax = t.dataset.max || "10";

    row.innerHTML = `
      <div style="margin-bottom:4px;font-weight:600">${name}</div>
      <input type="number" class="max-input" data-index="${i}" value="${currentMax}"
        style="width:100%;padding:6px;border-radius:6px;border:1px solid #ccc">
    `;
    maxList.appendChild(row);
  });

  maxModal.style.display = "flex";
};

document.getElementById("max-cancel").onclick = () => {
  maxModal.style.display = "none";
};

document.getElementById("max-save").onclick = () => {
  const inputs = maxList.querySelectorAll(".max-input");
  const tables = document.querySelectorAll(".table");

  inputs.forEach(inp => {
    const idx = parseInt(inp.dataset.index, 10);
    const val = parseInt(inp.value || "0", 10);
    if (!val || val <= 0) return;

    const table = tables[idx];
    if (!table) return;

    table.dataset.max = String(val);
    updateTable(table);
  });

  const bulk = document.getElementById("bulk-max");
  if (bulk && bulk.value) {
    const v = parseInt(bulk.value, 10);
    if (v > 0) {
      document.querySelectorAll(".table").forEach(t => {
        t.dataset.max = String(v);
        updateTable(t);
      });
    }
  }

  saveState();
  maxModal.style.display = "none";
};

/* =======================
   MOVE KH√ÅCH (M≈®I T√äN ANDROID)
   ======================= */

function openMoveGuestModal(li){
  const box = document.getElementById("move-list");
  box.innerHTML = "";

  document.querySelectorAll(".table").forEach((t, i) => {
    const btn = document.createElement("button");
    btn.textContent = t.dataset.baseName;
    btn.className = "btn";
    btn.style.width = "100%";
    btn.onclick = () => {
      t.querySelector(".guest-list").appendChild(li);
      clearSelectedGuest();
      document.getElementById("move-modal").style.display = "none";
      document.querySelectorAll(".table").forEach(updateTable);
      saveState();
      updateUnassignedView();
    };
    box.appendChild(btn);
  });

  document.getElementById("move-modal").style.display = "flex";
}

document.getElementById("move-cancel").onclick = () => {
  document.getElementById("move-modal").style.display = "none";
};

/* =======================
   ƒê·ªîI T√äN B√ÄN + X√ìA B√ÄN + AUTO FIX
   ======================= */

tablesEl.addEventListener("click", e => {
  const table = e.target.closest(".table");
  if (!table) return;

  /* X√≥a b√†n */
if (e.target.classList.contains("delete-table-btn")) {
  if (confirm("X√≥a b√†n n√†y?")) {

    // 1) L·∫•y to√†n b·ªô kh√°ch trong b√†n
    const guests = [...table.querySelectorAll(".guest-list li:not(.drag-placeholder)")];

    // 2) ƒê∆∞a t·ª´ng kh√°ch v·ªÅ "Ch∆∞a s·∫Øp x·∫øp"
    guests.forEach(li => {
      unassigned.appendChild(li);
    });

    // 3) C·∫≠p nh·∫≠t giao di·ªán
    updateUnassignedView();

    // 4) X√≥a b√†n
    table.remove();

    // 5) C·∫≠p nh·∫≠t t·ªïng & l∆∞u
    updateSummary();
    saveState();
  }
}


  /* ƒê·ªïi t√™n b√†n */
  if (e.target.classList.contains("edit-table-btn")) {
    const newName = prompt("T√™n b√†n:", table.dataset.baseName);
    if (newName) {
      table.dataset.baseName = normalizeName(newName);
      updateTable(table);
      saveState();
    }
  }

  /* Quick add */
  if (e.target.classList.contains("quick-add-btn")) {
    const box = table.querySelector(".quick-add");
    box.classList.toggle("hidden");
    const input = box.querySelector(".quick-add-input");
    input.focus();

    input.onkeydown = ev => {
      if (ev.key === "Enter") {
        const name = normalizeName(input.value);
        if (name) {
          table.querySelector(".guest-list").appendChild(createGuestLi(name));
          updateTable(table);
          saveState();
        }
        input.value = "";
        box.classList.add("hidden");
      }
      if (ev.key === "Escape") {
        box.classList.add("hidden");
      }
    };
  }

  /* Auto fix */
  if (e.target.classList.contains("auto-fix-btn")) {
    const list = table.querySelector(".guest-list");
    const max = parseInt(table.dataset.max, 10);
    const items = [...list.querySelectorAll("li:not(.drag-placeholder)")];

    while (items.length > max) {
      unassigned.appendChild(items.pop());
    }

    updateTable(table);
    updateUnassignedView();
    saveState();
  }
});
/* =======================
   H∆Ø·ªöNG D·∫™N
   ======================= */

document.getElementById("help-btn").onclick = () => {
  document.getElementById("help-modal").style.display = "flex";
};

document.getElementById("help-close").onclick = () => {
  document.getElementById("help-modal").style.display = "none";
};

</script>

</body>
</html>
